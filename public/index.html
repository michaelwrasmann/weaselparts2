<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WeaselParts - Bauteile-Verwaltung</title>
  <link rel="stylesheet" href="/css/modern-styles.css">
  <link rel="stylesheet" href="/css/styles.css?v=20250807-1320">
  <link rel="stylesheet" href="/css/background-icons.css">
  <!-- KRITISCH: modal-fixes.js ZUERST laden -->
  <script src="/js/modal-fixes.js"></script>
  <!-- Page Transitions -->
  <script src="/js/page-transitions.js"></script>
  <!-- Modal Animations -->
  <script src="/js/modal-animations.js"></script>
</head>
<body class="page-home">

<div class="modern-container">
  <!-- Modern Header -->
  <header class="modern-header">
    <nav class="modern-nav">
      <a href="/" class="modern-logo">
        <img src="/images/weasel-svgrepo-com.svg" alt="WeaselParts">
        <span>WeaselParts</span>
      </a>
      
      <!-- Search Bar -->
      <div class="modern-search">
        <input type="text" placeholder="Bauteile suchen..." id="global-search">
      </div>
      
      <!-- Sensor Data -->
      <div class="modern-sensors">
        <div class="modern-sensor temp" id="temperature-value">--¬∞C</div>
        <div class="modern-sensor humid" id="humidity-value">--%</div>
        <select class="modern-select" id="sensor-location-select" style="width: auto; padding: 4px 8px;">
          <option value="ssa">Jarvis-Ecke</option>
          <option value="int_up">Am Telefon</option>
          <option value="emp">Empore</option>
        </select>
      </div>
      
      <!-- Navigation Buttons -->
      <div class="modern-nav-buttons">
        <button class="modern-nav-btn" id="add-component-nav-btn" title="Neues Bauteil">
          <img src="/images/button_add_component.png" alt="Neues Bauteil">
        </button>
        <button class="modern-nav-btn" id="manage-cabinets-nav-btn" title="Schr√§nke verwalten">
          <img src="/images/button_manage_cabinet.png" alt="Schr√§nke">
        </button>
        <a href="/ICD.html" class="modern-nav-btn" title="ICD">
          <img src="/images/button_icd.png" alt="ICD">
        </a>
        <a href="/lab-overview.html" class="modern-nav-btn" title="Labor-√úbersicht">
          <img src="/images/button_lab_overview.png" alt="Labor">
        </a>
        <a href="/glue-protocol.html" class="modern-nav-btn" title="Klebeprotokoll">
          <img src="/images/button_glue_protocol.png" alt="Kleben">
        </a>
        <a href="/settings.html" class="modern-nav-btn" title="Einstellungen">
          <img src="/images/button_settings.png" alt="Settings">
        </a>
      </div>
    </nav>
  </header>

  <!-- Split Screen Layout Below Header -->
  <div class="modern-wrapper">
    <!-- Content Panel - Left Side 60% -->
    <div class="content-panel">
      <div class="modern-content">
        
        <!-- Page Header -->
        <div class="modern-page-header">
          <h1 class="modern-title">Komponenten</h1>
          <p class="modern-subtitle">Verwalte deine Bauteile - Einfach scannen oder √ºber die Suche finden</p>
        </div>

        <!-- Stats Cards -->
        <div style="display: flex; gap: var(--space-md); margin-bottom: var(--space-lg); width: 100%;">
          <div class="modern-card" style="padding: var(--space-sm); flex: 1;">
            <div style="text-align: center;">
              <div style="font-size: 0.5rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px;">GESAMT</div>
              <div style="font-size: 1.25rem; font-weight: 900; color: var(--table-header-primary);" id="total-components">0</div>
            </div>
          </div>
          <div class="modern-card" style="padding: var(--space-sm); flex: 1;">
            <div style="text-align: center;">
              <div style="font-size: 0.5rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px;">SCHR√ÑNKE</div>
              <div style="font-size: 1.25rem; font-weight: 900; color: var(--table-header-secondary);" id="total-cabinets">0</div>
            </div>
          </div>
          <div class="modern-card" style="padding: var(--space-sm); flex: 1;">
            <div style="text-align: center;">
              <div style="font-size: 0.5rem; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px;">EINGELAGERT</div>
              <div style="font-size: 1.25rem; font-weight: 900; color: var(--table-header-success);" id="stored-components">0</div>
            </div>
          </div>
        </div>

        <!-- Components Section -->
        <div class="modern-panel">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xl); flex-wrap: wrap; gap: 16px;">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0;">Alle Komponenten <span id="filter-count"></span></h2>
            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <label for="project-filter" style="font-size: 0.875rem; font-weight: 500; color: var(--gray-700);">Projekt:</label>
                <select id="project-filter" class="modern-select" style="min-width: 150px;">
                  <option value="">Alle Projekte</option>
                </select>
              </div>
              <button class="modern-btn modern-btn-primary" onclick="window.location.href='/add-component.html'">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Hinzuf√ºgen
              </button>
            </div>
          </div>

          <div class="modern-grid modern-grid-2" id="components-grid">
            <!-- Bauteile werden dynamisch geladen -->
          </div>
          
          <div style="display: flex; justify-content: center; align-items: center; gap: var(--space-md); margin-top: var(--space-xl);">
            <button class="modern-btn modern-btn-secondary" id="prev-page">&lt;</button>
            <span style="font-size: 0.875rem; color: var(--gray-600);">Seite <span id="current-page">1</span></span>
            <button class="modern-btn modern-btn-secondary" id="next-page">&gt;</button>
          </div>
        </div>

      </div>
    </div>
    
    <!-- Background Panel - Right Side 40% -->
    <div class="background-panel">
      <img src="/images/crane.png" alt="Crane" class="background-icon" style="position: absolute; top: 5%; right: 10%; width: 70%; opacity: 1;">
      <img src="/images/ar_glasses.png" alt="AR Glasses" class="background-icon" style="position: absolute; top: 45%; left: 5%; width: 60%; opacity: 1;">
      <img src="/images/background_icon_lab_overview.png" alt="Mars Planet" class="background-icon" style="position: absolute; bottom: 0%; right: 10%; width: 65%; opacity: 1;">
    </div>
  </div>
</div>

<!-- Barcode Scanner Modal -->
<div id="scanner-modal" class="modern-modal">
  <div class="modern-modal-content">
    <div class="modern-modal-header">
      <h3>Barcode Scanner</h3>
      <button class="modern-close-btn" id="close-scanner">&times;</button>
    </div>
    <div class="modern-modal-body">
      <div style="margin-bottom: var(--space-xl);">
        <label class="modern-label" for="barcode-input">Barcode eingeben oder scannen:</label>
        <input type="text" id="barcode-input" placeholder="Barcode eingeben..." class="modern-input" autofocus>
        <button class="modern-btn modern-btn-primary" id="process-barcode" style="margin-top: var(--space-md);">Verarbeiten</button>
      </div>
      <div style="background: var(--gray-50); padding: var(--space-lg); border-radius: var(--radius-md); border-left: 4px solid var(--table-header-primary);">
        <p>üì± Geben Sie einen Barcode ein oder verwenden Sie einen Barcode-Scanner</p>
        <div style="margin-top: var(--space-md); display: flex; flex-direction: column; gap: var(--space-sm);">
          <div><strong>Bauteile:</strong> Normale Barcodes (z.B. WP-12345)</div>
          <div><strong>Klebeprotokolle:</strong> GLUE-Codes (z.B. GLUE-12345678)</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal f√ºr Bauteile -->
<div id="component-delete-modal" class="modern-modal">
  <div class="modern-modal-content" style="max-width: 400px;">
    <div class="modern-modal-header">
      <h3 style="font-size: 1.25rem; font-weight: 700; margin: 0; color: #FF6B6B;">‚ö†Ô∏è Bauteil l√∂schen</h3>
      <button class="modern-close-btn" id="close-component-delete">&times;</button>
    </div>
    
    <div class="modern-modal-body text-center">
      <svg width="60" height="60" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 16px; color: #FF6B6B;">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
      </svg>
      
      <p id="component-delete-message" style="font-size: 1rem; margin-bottom: 16px;"></p>
      <div id="component-delete-details" style="background: #FFF5F5; border: 1px solid #FFE0E0; border-radius: 8px; padding: 12px; margin-bottom: 16px; text-align: left;">
        <!-- Wird dynamisch gef√ºllt -->
      </div>
      <div style="background: #FFF5F5; border: 1px solid #FFE0E0; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
        <strong style="color: #FF6B6B;">Achtung:</strong> Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.
      </div>
    </div>
    
    <div class="modern-modal-footer">
      <button class="modern-btn modern-btn-secondary" id="cancel-component-delete">Abbrechen</button>
      <button class="modern-btn" style="background: #FF6B6B; color: white;" id="confirm-component-delete">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
        </svg>
        Ja, l√∂schen
      </button>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<!-- Scripts -->
<script src="/js/api.js"></script>
<script src="/js/common.js?v=20250807-1320"></script>
<script src="/js/fixes.js"></script>

<script>
let currentPage = 1;
const itemsPerPage = 8;
let allComponents = [];
let filteredComponents = [];
let currentComponentToDelete = null;

document.addEventListener('DOMContentLoaded', async () => {
  console.log('üè† Index-Modern.html wird initialisiert...');
  
  // KRITISCHER FIX: Alle Modals explizit schlie√üen
  try {
    document.querySelectorAll('.modal, .modern-modal').forEach(modal => {
      modal.classList.remove('active');
      modal.style.display = 'none';
      modal.style.opacity = '0';
      modal.style.visibility = 'hidden';
    });
    console.log('‚úÖ Modals geschlossen');
  } catch (error) {
    console.error('‚ùå Modal-Fehler:', error);
  }
  
  // Setup navigation
  setupNavigation();
  
  // Initialisierung
  try {
    await loadComponents();
    setupEventListeners();
    await updateStats();
    await loadSensorData();
    startSensorRefresh();
    console.log('‚úÖ Index-Modern.html erfolgreich initialisiert');
  } catch (error) {
    console.error('‚ùå Initialisierungsfehler:', error);
    showMessage('Fehler beim Laden der Seite. Seite wird neu geladen...', 'error');
    setTimeout(() => window.location.reload(), 3000);
  }
});

// Setup Navigation
function setupNavigation() {
  const addBtn = document.getElementById('add-component-nav-btn');
  if (addBtn) {
    addBtn.addEventListener('click', () => {
      window.location.href = '/add-component.html';
    });
  }

  const manageCabinetsBtn = document.getElementById('manage-cabinets-nav-btn');
  if (manageCabinetsBtn) {
    manageCabinetsBtn.addEventListener('click', () => {
      window.location.href = '/manage-cabinets.html';
    });
  }
  
  const globalSearch = document.getElementById('global-search');
  if (globalSearch) {
    globalSearch.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && e.target.value.trim()) {
        handleGlobalSearch();
      }
    });
    globalSearch.addEventListener('input', handleGlobalSearch);
  }
  
  // Sensor Location Dropdown
  const locationSelect = document.getElementById('sensor-location-select');
  if (locationSelect) {
    locationSelect.addEventListener('change', async () => {
      await loadSensorData();
    });
  }
}

function setupEventListeners() {
  console.log('üîß Event Listeners werden eingerichtet...');
  
  // Project Filter
  const projectFilter = document.getElementById('project-filter');
  if (projectFilter) {
    projectFilter.addEventListener('change', handleProjectFilter);
  }
  
  // Pagination
  const prevBtn = document.getElementById('prev-page');
  if (prevBtn) {
    prevBtn.addEventListener('click', () => changePage(-1));
  }
  
  const nextBtn = document.getElementById('next-page');
  if (nextBtn) {
    nextBtn.addEventListener('click', () => changePage(1));
  }
  
  // Delete Modal Event Listeners
  setupDeleteModalEventListeners();
  
  // Barcode Scanner Event Listeners
  setupBarcodeScanner();
  
  console.log('‚úÖ Event Listeners eingerichtet');
}

// Delete Modal Event Listeners
function setupDeleteModalEventListeners() {
  const closeDeleteBtn = document.getElementById('close-component-delete');
  if (closeDeleteBtn) {
    closeDeleteBtn.addEventListener('click', closeComponentDeleteModal);
  }
  
  const confirmDeleteBtn = document.getElementById('confirm-component-delete');
  if (confirmDeleteBtn) {
    confirmDeleteBtn.addEventListener('click', handleConfirmComponentDelete);
  }
  
  const cancelDeleteBtn = document.getElementById('cancel-component-delete');
  if (cancelDeleteBtn) {
    cancelDeleteBtn.addEventListener('click', closeComponentDeleteModal);
  }
  
  // Escape key to close modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeComponentDeleteModal();
    }
  });
  
  // Click outside to close modal
  const modal = document.getElementById('component-delete-modal');
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeComponentDeleteModal();
      }
    });
  }
}

async function loadComponents() {
  try {
    console.log('üì¶ Lade Bauteile...');
    allComponents = await api.getAllComponents();
    filteredComponents = [...allComponents];
    renderComponents();
    await loadProjectFilter();
    console.log(`‚úÖ ${allComponents.length} Bauteile geladen`);
  } catch (error) {
    console.error('‚ùå Fehler beim Laden der Bauteile:', error);
    showMessage(`Fehler beim Laden der Bauteile: ${error.message}`, 'error');
    
    allComponents = [];
    filteredComponents = [];
    renderComponents();
  }
}

async function loadProjectFilter() {
  try {
    const projectFilter = document.getElementById('project-filter');
    if (!projectFilter) return;

    const uniqueProjects = [...new Set(allComponents
      .map(component => component.project)
      .filter(project => project && project.trim())
    )].sort();

    projectFilter.innerHTML = '<option value="">Alle Projekte</option>';

    uniqueProjects.forEach(project => {
      const option = document.createElement('option');
      option.value = project;
      option.textContent = project;
      projectFilter.appendChild(option);
    });

    console.log(`‚úÖ ${uniqueProjects.length} Projekte f√ºr Filter geladen`);
  } catch (error) {
    console.error('‚ùå Fehler beim Laden der Projekt-Filter:', error);
  }
}

function renderComponents() {
  const grid = document.getElementById('components-grid');
  if (!grid) {
    console.error('‚ùå Components Grid nicht gefunden');
    return;
  }
  
  grid.innerHTML = '';
  
  // Update filter count
  const filterCount = document.getElementById('filter-count');
  if (filterCount) {
    const totalComponents = allComponents.length;
    const filteredCount = filteredComponents.length;
    
    if (filteredCount === totalComponents) {
      filterCount.textContent = `(${totalComponents})`;
      filterCount.style.color = 'var(--gray-600)';
    } else {
      filterCount.textContent = `(${filteredCount} von ${totalComponents})`;
      filterCount.style.color = 'var(--table-header-primary)';
    }
  }
  
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageComponents = filteredComponents.slice(startIndex, endIndex);
  
  if (pageComponents.length === 0) {
    grid.innerHTML = '<div class="modern-empty-state"><h3>Keine Bauteile gefunden</h3><p>Versuchen Sie eine andere Suche oder f√ºgen Sie neue Bauteile hinzu.</p></div>';
    return;
  }
  
  pageComponents.forEach(component => {
    try {
      const componentCard = createComponentCard(component);
      grid.appendChild(componentCard);
    } catch (error) {
      console.error('Fehler beim Erstellen der Komponenten-Karte:', error);
    }
  });
  
  updatePagination();
}

function createComponentCard(component) {
  const card = document.createElement('div');
  card.className = 'modern-card';
  card.dataset.barcode = component.barcode;
  card.style.cursor = 'pointer';
  card.style.position = 'relative';
  card.style.paddingTop = '140px';
  
  // Sichere Bildbehandlung
  let imageSection;
  if (component.image_url && component.image_url.trim() !== '') {
    imageSection = `
      <div style="position: absolute; top: 0; left: 0; right: 0; height: 140px; overflow: hidden;">
        <img src="${component.image_url}" 
             alt="${component.name || 'Bauteilbild'}" 
             style="width: 100%; height: 140px; object-fit: cover;"
             onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=height:120px;display:flex;align-items:center;justify-content:center;color:var(--gray-400);background:var(--gray-50)>Kein Bild</div>';"
             loading="lazy">
      </div>
    `;
  } else {
    imageSection = `<div style="position: absolute; top: 0; left: 0; right: 0; height: 140px; display: flex; align-items: center; justify-content: center; color: var(--gray-400); background: var(--gray-50);">Kein Bild</div>`;
  }
  
  // Sichere Datenerstellung
  const safeName = (component.name || 'Unbenannt').replace(/'/g, '&apos;');
  const safeBarcode = (component.barcode || '').replace(/'/g, '&apos;');
  
  card.innerHTML = `
    ${imageSection}
    <div style="padding: var(--space-md);">
      <h3 style="font-size: 1.125rem; font-weight: 700; margin-bottom: var(--space-sm);">${component.name || 'Unbenannt'}</h3>
      <div style="display: flex; flex-direction: column; gap: var(--space-xs); margin-bottom: var(--space-md); font-size: 0.875rem; color: var(--gray-600);">
        <div><strong>Barcode:</strong> ${component.barcode}</div>
        <div><strong>Projekt:</strong> ${component.project || '-'}</div>
        <div><strong>Verantwortlicher:</strong> ${component.responsible_engineer || '-'}</div>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 0.875rem; color: var(--gray-500); display: flex; align-items: center; gap: 4px;">
          <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
          </svg>
          ${component.schrank_name || 'Nicht eingelagert'}
        </span>
        <div class="modern-actions">
          <button class="modern-action-btn" onclick="event.stopPropagation(); viewHistoricalRecord('${safeBarcode}')" title="Historical Record">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
            </svg>
          </button>
          <button class="modern-action-btn edit" onclick="event.stopPropagation(); editComponent('${safeBarcode}')" title="Bearbeiten">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
          </button>
          <button class="modern-action-btn delete" onclick="event.stopPropagation(); showComponentDeleteModal('${safeBarcode}', '${safeName}')" title="L√∂schen">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Click-Event f√ºr die gesamte Karte
  card.addEventListener('click', (event) => {
    if (!event.target.closest('.modern-actions')) {
      editComponent(component.barcode);
    }
  });
  
  return card;
}

function applyFilters() {
  const searchInput = document.getElementById('global-search');
  const projectFilter = document.getElementById('project-filter');
  
  const searchQuery = searchInput ? searchInput.value.toLowerCase().trim() : '';
  const selectedProject = projectFilter ? projectFilter.value : '';
  
  filteredComponents = allComponents.filter(component => {
    const matchesSearch = !searchQuery || (
      (component.name && component.name.toLowerCase().includes(searchQuery)) ||
      (component.barcode && component.barcode.toLowerCase().includes(searchQuery)) ||
      (component.project && component.project.toLowerCase().includes(searchQuery)) ||
      (component.responsible_engineer && component.responsible_engineer.toLowerCase().includes(searchQuery)) ||
      (component.equipment_name && component.equipment_name.toLowerCase().includes(searchQuery))
    );
    
    const matchesProject = !selectedProject || (component.project === selectedProject);
    
    return matchesSearch && matchesProject;
  });
  
  currentPage = 1;
  renderComponents();
}

function handleGlobalSearch() {
  applyFilters();
}

function handleProjectFilter() {
  applyFilters();
}

function changePage(direction) {
  const totalPages = Math.ceil(filteredComponents.length / itemsPerPage);
  const newPage = currentPage + direction;
  
  if (newPage >= 1 && newPage <= totalPages) {
    currentPage = newPage;
    renderComponents();
  }
}

function updatePagination() {
  const totalPages = Math.ceil(filteredComponents.length / itemsPerPage);
  
  const currentPageEl = document.getElementById('current-page');
  if (currentPageEl) {
    currentPageEl.textContent = currentPage;
  }
  
  const prevBtn = document.getElementById('prev-page');
  if (prevBtn) {
    prevBtn.disabled = currentPage === 1;
  }
  
  const nextBtn = document.getElementById('next-page');
  if (nextBtn) {
    nextBtn.disabled = currentPage === totalPages || totalPages === 0;
  }
}

// Globale Funktionen f√ºr Component-Karten
window.editComponent = function(barcode) {
  if (barcode) {
    window.location.href = `/edit-component.html?barcode=${encodeURIComponent(barcode)}`;
  }
};

window.viewHistoricalRecord = function(barcode) {
  if (barcode) {
    window.location.href = `/historical-record.html?barcode=${encodeURIComponent(barcode)}`;
  }
};

// Delete Modal anzeigen
window.showComponentDeleteModal = function(barcode, name) {
  if (!barcode) {
    showMessage('Fehler: Kein Barcode angegeben', 'error');
    return;
  }
  
  const component = allComponents.find(c => c.barcode === barcode);
  currentComponentToDelete = component;
  
  if (!component) {
    showMessage('Bauteil nicht gefunden', 'error');
    return;
  }
  
  const messageEl = document.getElementById('component-delete-message');
  const detailsEl = document.getElementById('component-delete-details');
  
  if (messageEl) {
    messageEl.textContent = `M√∂chtest du das Bauteil "${name}" wirklich l√∂schen?`;
  }
  
  if (detailsEl) {
    detailsEl.innerHTML = `
      <div style="display: flex; flex-direction: column; gap: 8px; font-size: 0.875rem;">
        <div><strong>Barcode:</strong> ${component.barcode}</div>
        <div><strong>Projekt:</strong> ${component.project || '-'}</div>
        <div><strong>Verantwortlicher:</strong> ${component.responsible_engineer || '-'}</div>
        ${component.schrank_name ? 
          `<div style="color: #FF6B6B;"><strong>‚ö†Ô∏è Standort:</strong> ${component.schrank_name} (wird automatisch ausgelagert)</div>` :
          '<div><strong>Standort:</strong> Nicht eingelagert</div>'
        }
      </div>
    `;
  }
  
  const modal = document.getElementById('component-delete-modal');
  if (modal) {
    modal.classList.add('active');
  }
};

// Delete Modal schlie√üen
function closeComponentDeleteModal() {
  const modal = document.getElementById('component-delete-modal');
  if (modal) {
    modal.classList.remove('active');
  }
  currentComponentToDelete = null;
}

// L√∂schen best√§tigen
async function handleConfirmComponentDelete() {
  if (!currentComponentToDelete) {
    showMessage('Fehler: Kein Bauteil zum L√∂schen ausgew√§hlt', 'error');
    return;
  }
  
  try {
    const submitBtn = document.getElementById('confirm-component-delete');
    const originalText = submitBtn ? submitBtn.innerHTML : '';
    
    if (submitBtn) {
      submitBtn.innerHTML = '<span class="modern-loading"></span> Wird gel√∂scht...';
      submitBtn.disabled = true;
    }
    
    await api.deleteComponent(currentComponentToDelete.barcode);
    showMessage('Bauteil erfolgreich gel√∂scht!', 'success');
    
    closeComponentDeleteModal();
    
    await loadComponents();
    await updateStats();
    
  } catch (error) {
    console.error('Fehler beim L√∂schen:', error);
    showMessage(`Fehler beim L√∂schen: ${error.message}`, 'error');
    
    const submitBtn = document.getElementById('confirm-component-delete');
    if (submitBtn) {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  }
}

async function updateStats() {
  try {
    console.log('üìä Aktualisiere Statistiken...');
    
    const totalComponents = allComponents.length;
    const storedComponents = allComponents.filter(c => c.schrank_id).length;
    
    const updateElement = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    };
    
    updateElement('total-components', totalComponents);
    updateElement('stored-components', storedComponents);
    
    try {
      const cabinets = await api.getCabinets();
      updateElement('total-cabinets', cabinets.length);
    } catch (error) {
      console.error('Fehler beim Laden der Schr√§nke:', error);
      updateElement('total-cabinets', '?');
    }
    
    console.log('‚úÖ Statistiken aktualisiert');
  } catch (error) {
    console.error('‚ùå Fehler beim Aktualisieren der Statistiken:', error);
  }
}

// Sensor Data Functions
async function loadSensorData() {
  try {
    const locationSelect = document.getElementById('sensor-location-select');
    const location = locationSelect ? locationSelect.value : 'ssa';
    
    const response = await fetch(`/api/sensors/current/${location}`);
    if (!response.ok) return;
    
    const sensorData = await response.json();
    updateSensorDisplay(sensorData);
  } catch (error) {
    console.error('‚ùå Sensordaten Fehler:', error);
  }
}

function updateSensorDisplay(data) {
  try {
    const tempValue = document.getElementById('temperature-value');
    if (tempValue) {
      if (data.temperature && data.temperature.temperature !== null && !isNaN(data.temperature.temperature)) {
        tempValue.textContent = `${data.temperature.temperature.toFixed(1)}¬∞C`;
      } else {
        tempValue.textContent = '--¬∞C';
      }
    }
    
    const humValue = document.getElementById('humidity-value');
    if (humValue) {
      if (data.humidity && data.humidity.humidity !== null && !isNaN(data.humidity.humidity)) {
        humValue.textContent = `${data.humidity.humidity.toFixed(1)}%`;
      } else {
        humValue.textContent = '--%';
      }
    }
  } catch (error) {
    console.error('‚ùå Fehler beim Aktualisieren der Sensoranzeige:', error);
  }
}

function startSensorRefresh() {
  setInterval(async () => {
    await loadSensorData();
  }, 30000);
}

// Barcode Scanner Functions
function setupBarcodeScanner() {
  const scannerModal = document.getElementById('scanner-modal');
  const closeScannerBtn = document.getElementById('close-scanner');
  const barcodeInput = document.getElementById('barcode-input');
  const processBarcodeBtn = document.getElementById('process-barcode');
  
  if (closeScannerBtn) {
    closeScannerBtn.addEventListener('click', () => {
      scannerModal.classList.remove('active');
      if (barcodeInput) barcodeInput.value = '';
    });
  }
  
  if (barcodeInput) {
    barcodeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        processBarcode();
      }
    });
  }
  
  if (processBarcodeBtn) {
    processBarcodeBtn.addEventListener('click', processBarcode);
  }
}

async function processBarcode() {
  const barcodeInput = document.getElementById('barcode-input');
  const scannerModal = document.getElementById('scanner-modal');
  
  if (!barcodeInput || !barcodeInput.value.trim()) {
    showMessage('Bitte geben Sie einen Barcode ein', 'error');
    return;
  }
  
  const barcode = barcodeInput.value.trim();
  
  try {
    if (barcode.startsWith('GLUE-')) {
      console.log('üîß Klebeprotokoll-Barcode erkannt:', barcode);
      
      const response = await fetch(`/api/glue-protocols/${barcode}`);
      if (response.ok) {
        const protocol = await response.json();
        showGlueProtocolDetails(protocol);
      } else {
        showMessage('Klebeprotokoll nicht gefunden', 'error');
      }
    } else {
      console.log('üì¶ Bauteil-Barcode erkannt:', barcode);
      
      const response = await fetch(`/api/bauteil/${barcode}`);
      if (response.ok) {
        const component = await response.json();
        window.location.href = `/edit-component.html?barcode=${encodeURIComponent(barcode)}`;
      } else {
        showMessage('Bauteil nicht gefunden', 'error');
      }
    }
    
    scannerModal.classList.remove('active');
    barcodeInput.value = '';
    
  } catch (error) {
    console.error('‚ùå Fehler beim Verarbeiten des Barcodes:', error);
    showMessage('Fehler beim Verarbeiten des Barcodes', 'error');
  }
}

function showGlueProtocolDetails(protocol) {
  // Implementation f√ºr Glue Protocol Details Modal
  console.log('Glue Protocol Details:', protocol);
}

// Message display function
function showMessage(message, type = 'info') {
  console.log(`${type.toUpperCase()}: ${message}`);
  
  const toast = document.createElement('div');
  toast.className = `modern-toast ${type}`;
  toast.innerHTML = `
    <div style="display: flex; align-items: center; gap: 12px;">
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        ${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' :
          type === 'error' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>' :
          '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'}
      </svg>
      <span>${message}</span>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 4000);
}

// URL-Parameter verarbeiten
const urlParams = new URLSearchParams(window.location.search);
const searchQuery = urlParams.get('search');

setTimeout(() => {
  if (searchQuery) {
    const globalSearch = document.getElementById('global-search');
    if (globalSearch) {
      globalSearch.value = searchQuery;
      handleGlobalSearch();
    }
  }
}, 1000);

// Error Handling
window.addEventListener('error', function(e) {
  console.error('‚ùå Globaler Fehler:', e);
  if (e.message && e.message.includes('null')) {
    showMessage('Ein Element konnte nicht gefunden werden. Bitte lade die Seite neu.', 'warning');
  }
});
</script>

</body>
</html>