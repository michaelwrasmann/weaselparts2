<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WeaselParts - Bauteile-Verwaltung</title>
  <link rel="stylesheet" href="/css/styles.css">
  <!-- KRITISCH: modal-fixes.js ZUERST laden -->
  <script src="/js/modal-fixes.js"></script>
</head>
<body>
<header>
  <div class="header-content">
    <a href="/" class="logo">
      <svg class="logo-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <path fill="currentColor" d="M508.862,112.381c-4.797-3.806-47.682-37.184-75.929-37.184c-27.581,0-52.308,23.844-69.626,67.139c-10.743,26.856-24.697,26.856-38.192,26.856c-5.776,0-20.502-2.82-34.744-5.548c-20.389-3.905-43.49-8.33-57.625-8.275c-14.746,0.057-52.816,3.26-87.728,31.698c-31.702,25.822-51.001,65.459-56.011,114.89c-8.069,2.417-23.771,7.404-39.669,14.027C15.677,330.01,0,343.277,0,357.737c0,21.496,16.178,42.239,45.556,58.41c22.094,12.163,50.426,20.657,68.898,20.657c24.792,0,41.517-16.152,43.365-31.767c1.286-10.873-4.274-24.152-23.736-28.825c-19.624-4.71-34.346-10.988-44.13-16.064c11.112-2.083,23.886-2.809,31.072-2.94c4.073,2.64,14.61,9.738,24.149,16.231c1.376,0.938,3.002,1.439,4.668,1.439h70.773c3.118,0,5.973-1.748,7.389-4.526s1.156-6.115-0.677-8.639l-13.728-18.914c2.637-2.415,5.107-5.066,7.332-8.005c5.195-6.864,8.692-14.66,10.543-23.318c13.559-1.22,56.52-5.8,84.509-16.876c9.94,14.204,21.305,29.862,21.499,30.128c6.448,8.878,15.779,21.586,23.615,31.712c11.772,15.211,14.051,17.314,18.758,17.314h44.233c3.059,0,5.87-1.684,7.313-4.38c1.443-2.697,1.285-5.969-0.412-8.514l-14.236-21.355c-4.011-6.015-11.166-8.898-18.224-7.349l-2.914,0.64c-7.463-14.329-16.73-35.639-16.32-45.486c0.111-2.656,0.332-4.95,0.636-7.011c23.591-9.243,60.487-37.432,69.947-80.001c4.407-19.833,8.867-44.304,8.911-44.548c0.159-0.874,0.171-1.738,0.061-2.572c16.615-1.917,37.452-8.366,38.481-8.686c2.154-0.671,3.941-2.192,4.95-4.209l8.847-17.693C512.879,119.077,511.935,114.819,508.862,112.381z"/>
      </svg>
      <h1>WeaselParts</h1>
    </a>
    <nav class="top-nav">
      <div class="nav-left">
        <div class="lab-info">
          <div class="location-selector">
            <select id="sensor-location-select" class="location-dropdown">
              <option value="ssa">Jarvis-Ecke</option>
              <option value="int_up">Am Telefon</option>
              <option value="int_low">Empore</option>
            </select>
          </div>
          <div class="mini-sensors">
            <span class="mini-sensor temp">
              <span id="temperature-value">--¬∞C</span>
            </span>
            <span class="mini-sensor humid">
              <span id="humidity-value">--%</span>
            </span>
          </div>
        </div>
        <div class="search-container">
          <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input type="text" placeholder="Bauteile suchen" id="global-search">
        </div>
      </div>
      <div class="nav-icons">
        <button class="nav-btn" id="add-component-nav-btn" title="Neues Bauteil">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V18M18 12L6 12"></path>
          </svg>
        </button>
        <button class="nav-btn" id="manage-cabinets-nav-btn" title="Schr√§nke verwalten">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
          </svg>
        </button>
        <a href="/ICD.html" class="nav-btn" title="ICD">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
        </a>
        <a href="/lab-overview.html" class="nav-btn" title="Labor-√úbersicht">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
          </svg>
        </a>
        <a href="/glue-protocol.html" class="nav-btn" title="Klebeprotokoll">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
        </a>
        <a href="/settings.html" class="nav-btn" title="Einstellungen">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
        </a>
      </div>
    </nav>
  </div>
</header>

  <main class="main-content">
    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">Komponenten</h1>
      <p class="page-subtitle">Verwalte deine Bauteile - Einfach scannen oder √ºber die Suche finden</p>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Gesamt</div>
        <div class="stat-value" id="total-components">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Schr√§nke</div>
        <div class="stat-value" id="total-cabinets">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Eingelagert</div>
        <div class="stat-value" id="stored-components">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Nicht eingelagert</div>
        <div class="stat-value" id="unstored-components">0</div>
      </div>
    </div>


    <!-- Hauptinhalt - Bauteile Grid -->
    <div class="components-container">
      <div class="section-header">
        <h2 class="section-title">Alle Komponenten <span id="filter-count"></span></h2>
        <div class="header-controls">
          <div class="filter-group">
            <label for="project-filter">Projekt:</label>
            <select id="project-filter" class="filter-dropdown">
              <option value="">Alle Projekte</option>
            </select>
          </div>
          <button class="scan-btn" id="scan-barcode-btn" title="Barcode scannen">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V6a1 1 0 00-1-1H5a1 1 0 00-1 1v1a1 1 0 001 1zm12 0h2a1 1 0 001-1V6a1 1 0 00-1-1h-2a1 1 0 00-1 1v1a1 1 0 001 1zM5 20h2a1 1 0 001-1v-1a1 1 0 00-1-1H5a1 1 0 00-1 1v1a1 1 0 001 1z"></path>
            </svg>
            Scannen
          </button>
          <button class="add-btn" onclick="window.location.href='/add-component.html'">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Hinzuf√ºgen
          </button>
        </div>
      </div>

      <div class="components-grid" id="components-grid">
        <!-- Bauteile werden dynamisch geladen -->
      </div>
      
      <div class="pagination">
        <button class="page-btn" id="prev-page">&lt;</button>
        <span class="page-info">Seite <span id="current-page">1</span></span>
        <button class="page-btn" id="next-page">&gt;</button>
      </div>
    </div>

  </main>

  <!-- Barcode Scanner Modal -->
  <div id="scanner-modal" class="modal" style="display: none;">
    <div class="modal-content scanner-modal-content">
      <div class="modal-header">
        <h3>Barcode Scanner</h3>
        <button class="close-modal" id="close-scanner">&times;</button>
      </div>
      <div class="scanner-body">
        <div class="scanner-input-section">
          <label for="barcode-input">Barcode eingeben oder scannen:</label>
          <input type="text" id="barcode-input" placeholder="Barcode eingeben..." autofocus>
          <button class="btn primary" id="process-barcode">Verarbeiten</button>
        </div>
        <div class="scanner-instructions">
          <p>üì± Geben Sie einen Barcode ein oder verwenden Sie einen Barcode-Scanner</p>
          <div class="scanner-types">
            <div class="scanner-type">
              <strong>Bauteile:</strong> Normale Barcodes (z.B. WP-12345)
            </div>
            <div class="scanner-type">
              <strong>Klebeprotokolle:</strong> GLUE-Codes (z.B. GLUE-12345678)
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal f√ºr Bauteile -->
  <div id="component-delete-modal" class="modal" style="display: none; opacity: 0; visibility: hidden;">
    <div class="modal-content confirmation-content">
      <div class="modal-header danger">
        <h3>Bauteil l√∂schen</h3>
        <button class="close-modal" id="close-component-delete">&times;</button>
      </div>
      
      <div class="confirmation-body">
        <div class="warning-icon">
          <svg width="60" height="60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
        </div>
        
        <div class="confirmation-text">
          <p id="component-delete-message"></p>
          <div class="component-delete-details" id="component-delete-details">
            <!-- Wird dynamisch gef√ºllt -->
          </div>
          <div class="warning-note">
            <strong>Achtung:</strong> Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.
          </div>
        </div>
        
        <div class="confirmation-actions">
          <button class="btn danger" id="confirm-component-delete">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            Ja, l√∂schen
          </button>
          <button class="btn secondary" id="cancel-component-delete">Abbrechen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container"></div>

  <!-- REPARIERTE SCRIPT-REIHENFOLGE -->
  <script src="/js/api.js"></script>
  <script src="/js/common.js"></script>
  <script src="/js/fixes.js"></script>
  
  <script>
    let currentPage = 1;
    const itemsPerPage = 8;
    let allComponents = [];
    let filteredComponents = [];
    let currentComponentToDelete = null; // Neue Variable f√ºr zu l√∂schendes Bauteil

document.addEventListener('DOMContentLoaded', async () => {
  console.log('üè† Index.html wird initialisiert...');
  
  // KRITISCHER FIX: Alle Modals explizit schlie√üen
  try {
    document.querySelectorAll('.modal').forEach(modal => {
      modal.classList.remove('active');
      modal.style.display = 'none';
      modal.style.opacity = '0';
      modal.style.visibility = 'hidden';
    });
    console.log('‚úÖ Modals geschlossen');
  } catch (error) {
    console.error('‚ùå Modal-Fehler:', error);
  }
  
  // Initialisierung
  try {
    await loadComponents();
    setupEventListeners();
    await updateStats();
    await loadSensorData();
    startSensorRefresh();
    console.log('‚úÖ Index.html erfolgreich initialisiert');
  } catch (error) {
    console.error('‚ùå Initialisierungsfehler:', error);
    showMessage('Fehler beim Laden der Seite. Seite wird neu geladen...', 'error');
    setTimeout(() => window.location.reload(), 3000);
  }
});

    function setupEventListeners() {
      console.log('üîß Event Listeners werden eingerichtet...');
      
      // Navigation Buttons - mit Null-Check
      const addBtn = document.getElementById('add-component-nav-btn');
      if (addBtn) {
        addBtn.addEventListener('click', () => {
          window.location.href = '/add-component.html';
        });
      }

      const manageCabinetsBtn = document.getElementById('manage-cabinets-nav-btn');
      if (manageCabinetsBtn) {
        manageCabinetsBtn.addEventListener('click', () => {
          window.location.href = '/manage-cabinets.html';
        });
      }
      
      // Global Search - mit Null-Check
      const globalSearch = document.getElementById('global-search');
      if (globalSearch) {
        globalSearch.addEventListener('input', handleGlobalSearch);
      }

      // Project Filter - mit Null-Check
      const projectFilter = document.getElementById('project-filter');
      if (projectFilter) {
        projectFilter.addEventListener('change', handleProjectFilter);
      }
      
      // Sensor Location Dropdown - mit Null-Check
      const locationSelect = document.getElementById('sensor-location-select');
      if (locationSelect) {
        locationSelect.addEventListener('change', async () => {
          await loadSensorData();
        });
      }
      
      // Pagination - mit Null-Check
      const prevBtn = document.getElementById('prev-page');
      if (prevBtn) {
        prevBtn.addEventListener('click', () => changePage(-1));
      }
      
      const nextBtn = document.getElementById('next-page');
      if (nextBtn) {
        nextBtn.addEventListener('click', () => changePage(1));
      }
      
      // Delete Modal Event Listeners hinzuf√ºgen
      setupDeleteModalEventListeners();
      
      // Barcode Scanner Event Listeners hinzuf√ºgen
      setupBarcodeScanner();
      
      console.log('‚úÖ Event Listeners eingerichtet');
    }

    // Neue Funktion: Delete Modal Event Listeners
    function setupDeleteModalEventListeners() {
      // Close Button
      const closeDeleteBtn = document.getElementById('close-component-delete');
      if (closeDeleteBtn) {
        closeDeleteBtn.addEventListener('click', closeComponentDeleteModal);
      }
      
      // Confirm Delete Button
      const confirmDeleteBtn = document.getElementById('confirm-component-delete');
      if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', handleConfirmComponentDelete);
      }
      
      // Cancel Button
      const cancelDeleteBtn = document.getElementById('cancel-component-delete');
      if (cancelDeleteBtn) {
        cancelDeleteBtn.addEventListener('click', closeComponentDeleteModal);
      }
      
      // Escape key to close modal
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeComponentDeleteModal();
        }
      });
      
      // Click outside to close modal
      const modal = document.getElementById('component-delete-modal');
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeComponentDeleteModal();
          }
        });
      }
    }

    async function loadComponents() {
      try {
        console.log('üì¶ Lade Bauteile...');
        allComponents = await api.getAllComponents();
        filteredComponents = [...allComponents];
        renderComponents();
        await loadProjectFilter(); // Load project filter after components
        console.log(`‚úÖ ${allComponents.length} Bauteile geladen`);
      } catch (error) {
        console.error('‚ùå Fehler beim Laden der Bauteile:', error);
        showMessage(`Fehler beim Laden der Bauteile: ${error.message}`, 'error');
        
        // Fallback: Leere Liste anzeigen
        allComponents = [];
        filteredComponents = [];
        renderComponents();
      }
    }

    async function loadProjectFilter() {
      try {
        const projectFilter = document.getElementById('project-filter');
        if (!projectFilter) return;

        // Get unique projects from components
        const uniqueProjects = [...new Set(allComponents
          .map(component => component.project)
          .filter(project => project && project.trim())
        )].sort();

        // Clear existing options except "Alle Projekte"
        projectFilter.innerHTML = '<option value="">Alle Projekte</option>';

        // Add project options
        uniqueProjects.forEach(project => {
          const option = document.createElement('option');
          option.value = project;
          option.textContent = project;
          projectFilter.appendChild(option);
        });

        console.log(`‚úÖ ${uniqueProjects.length} Projekte f√ºr Filter geladen`);
      } catch (error) {
        console.error('‚ùå Fehler beim Laden der Projekt-Filter:', error);
      }
    }

    function renderComponents() {
      const grid = document.getElementById('components-grid');
      if (!grid) {
        console.error('‚ùå Components Grid nicht gefunden');
        return;
      }
      
      grid.innerHTML = '';
      
      // Update filter count
      const filterCount = document.getElementById('filter-count');
      if (filterCount) {
        const totalComponents = allComponents.length;
        const filteredCount = filteredComponents.length;
        
        if (filteredCount === totalComponents) {
          filterCount.textContent = `(${totalComponents})`;
          filterCount.style.color = 'var(--text-secondary)';
        } else {
          filterCount.textContent = `(${filteredCount} von ${totalComponents})`;
          filterCount.style.color = 'var(--primary-color)';
        }
      }
      
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageComponents = filteredComponents.slice(startIndex, endIndex);
      
      if (pageComponents.length === 0) {
        grid.innerHTML = '<div class="no-components">Keine Bauteile gefunden</div>';
        return;
      }
      
      pageComponents.forEach(component => {
        try {
          const componentCard = createComponentCard(component);
          grid.appendChild(componentCard);
        } catch (error) {
          console.error('Fehler beim Erstellen der Komponenten-Karte:', error);
        }
      });
      
      updatePagination();
    }

    function createComponentCard(component) {
      const card = document.createElement('div');
      card.className = 'component-card';
      card.dataset.barcode = component.barcode;
      
      // Sichere Bildbehandlung
      let imageSection;
      if (component.image_url && component.image_url.trim() !== '') {
        imageSection = `
          <div class="component-image">
            <img src="${component.image_url}" 
                 alt="${component.name || 'Bauteilbild'}" 
                 onerror="this.style.display='none'; this.parentElement.innerHTML='<span>Bild</span>'; this.parentElement.classList.add('placeholder');"
                 loading="lazy">
          </div>
        `;
      } else {
        imageSection = `<div class="component-image placeholder">Bild</div>`;
      }
      
      // Sichere Datenerstellung
      const safeName = (component.name || 'Unbenannt').replace(/'/g, '&apos;');
      const safeBarcode = (component.barcode || '').replace(/'/g, '&apos;');
      
      card.innerHTML = `
        ${imageSection}
        <div class="component-info">
          <h3 class="component-name">${component.name || 'Unbenannt'}</h3>
          <p class="component-details"><strong>Barcode:</strong> ${component.barcode}</p>
          <p class="component-details"><strong>Projekt:</strong> ${component.project || '-'}</p>
          <p class="component-details"><strong>Verantwortlicher:</strong> ${component.responsible_engineer || '-'}</p>
          <div class="component-meta">
            <span class="component-location">
              <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
              </svg>
              ${component.schrank_name || 'Nicht eingelagert'}
            </span>
            <div class="component-actions">
              <button class="action-btn activity" onclick="event.stopPropagation(); viewHistoricalRecord('${safeBarcode}')" title="Historical Record">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                </svg>
              </button>
              <button class="action-btn edit" onclick="event.stopPropagation(); editComponent('${safeBarcode}')" title="Bearbeiten">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
              </button>
              <button class="action-btn delete" onclick="event.stopPropagation(); showComponentDeleteModal('${safeBarcode}', '${safeName}')" title="L√∂schen">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      `;
      
      // NEUE FUNKTION: Click-Event f√ºr die gesamte Karte hinzuf√ºgen
      card.addEventListener('click', (event) => {
        // Pr√ºfen ob das Klick-Event von einem Action-Button kommt
        if (!event.target.closest('.component-actions')) {
          editComponent(component.barcode);
        }
      });
      
      // Hover-Effekt f√ºr bessere UX
      card.style.cursor = 'pointer';
      
      return card;
    }

    function applyFilters() {
      const searchInput = document.getElementById('global-search');
      const projectFilter = document.getElementById('project-filter');
      
      const searchQuery = searchInput ? searchInput.value.toLowerCase().trim() : '';
      const selectedProject = projectFilter ? projectFilter.value : '';
      
      filteredComponents = allComponents.filter(component => {
        // Search filter
        const matchesSearch = !searchQuery || (
          (component.name && component.name.toLowerCase().includes(searchQuery)) ||
          (component.barcode && component.barcode.toLowerCase().includes(searchQuery)) ||
          (component.project && component.project.toLowerCase().includes(searchQuery)) ||
          (component.responsible_engineer && component.responsible_engineer.toLowerCase().includes(searchQuery)) ||
          (component.equipment_name && component.equipment_name.toLowerCase().includes(searchQuery))
        );
        
        // Project filter
        const matchesProject = !selectedProject || (component.project === selectedProject);
        
        return matchesSearch && matchesProject;
      });
      
      currentPage = 1;
      renderComponents();
    }

    function handleGlobalSearch() {
      applyFilters();
    }

    function handleProjectFilter() {
      applyFilters();
    }

    function changePage(direction) {
      const totalPages = Math.ceil(filteredComponents.length / itemsPerPage);
      const newPage = currentPage + direction;
      
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderComponents();
      }
    }

    function updatePagination() {
      const totalPages = Math.ceil(filteredComponents.length / itemsPerPage);
      
      const currentPageEl = document.getElementById('current-page');
      if (currentPageEl) {
        currentPageEl.textContent = currentPage;
      }
      
      const prevBtn = document.getElementById('prev-page');
      if (prevBtn) {
        prevBtn.disabled = currentPage === 1;
      }
      
      const nextBtn = document.getElementById('next-page');
      if (nextBtn) {
        nextBtn.disabled = currentPage === totalPages || totalPages === 0;
      }
    }

    // Globale Funktionen f√ºr Component-Karten
    window.editComponent = function(barcode) {
      if (barcode) {
        window.location.href = `/edit-component.html?barcode=${encodeURIComponent(barcode)}`;
      }
    };

    window.viewHistoricalRecord = function(barcode) {
      if (barcode) {
        window.location.href = `/historical-record.html?barcode=${encodeURIComponent(barcode)}`;
      }
    };

    // NEUE FUNKTION: Delete Modal anzeigen
    window.showComponentDeleteModal = function(barcode, name) {
      if (!barcode) {
        showMessage('Fehler: Kein Barcode angegeben', 'error');
        return;
      }
      
      // Komponente finden f√ºr zus√§tzliche Details
      const component = allComponents.find(c => c.barcode === barcode);
      currentComponentToDelete = component;
      
      if (!component) {
        showMessage('Bauteil nicht gefunden', 'error');
        return;
      }
      
      // Modal-Inhalt f√ºllen
      const messageEl = document.getElementById('component-delete-message');
      const detailsEl = document.getElementById('component-delete-details');
      
      if (messageEl) {
        messageEl.textContent = `M√∂chtest du das Bauteil "${name}" wirklich l√∂schen?`;
      }
      
      if (detailsEl) {
        detailsEl.innerHTML = `
          <div class="component-delete-info">
            <p><strong>Barcode:</strong> ${component.barcode}</p>
            <p><strong>Projekt:</strong> ${component.project || '-'}</p>
            <p><strong>Verantwortlicher:</strong> ${component.responsible_engineer || '-'}</p>
            ${component.schrank_name ? 
              `<p class="warning-text"><strong>‚ö†Ô∏è Standort:</strong> ${component.schrank_name} (wird automatisch ausgelagert)</p>` :
              '<p><strong>Standort:</strong> Nicht eingelagert</p>'
            }
          </div>
        `;
      }
      
      // Modal √∂ffnen
      openModal('component-delete-modal');
    };

    // NEUE FUNKTION: Delete Modal schlie√üen
    function closeComponentDeleteModal() {
      closeModal('component-delete-modal');
      currentComponentToDelete = null;
    }

    // NEUE FUNKTION: L√∂schen best√§tigen
    async function handleConfirmComponentDelete() {
      if (!currentComponentToDelete) {
        showMessage('Fehler: Kein Bauteil zum L√∂schen ausgew√§hlt', 'error');
        return;
      }
      
      try {
        const submitBtn = document.getElementById('confirm-component-delete');
        const originalText = submitBtn ? submitBtn.innerHTML : '';
        
        if (submitBtn) {
          submitBtn.innerHTML = '<span class="spinner"></span> Wird gel√∂scht...';
          submitBtn.disabled = true;
        }
        
        await api.deleteComponent(currentComponentToDelete.barcode);
        showMessage('Bauteil erfolgreich gel√∂scht!', 'success');
        
        // Modal schlie√üen
        closeComponentDeleteModal();
        
        // Komponenten neu laden
        await loadComponents();
        await updateStats();
        
      } catch (error) {
        console.error('Fehler beim L√∂schen:', error);
        showMessage(`Fehler beim L√∂schen: ${error.message}`, 'error');
        
        // Button zur√ºcksetzen
        const submitBtn = document.getElementById('confirm-component-delete');
        if (submitBtn) {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }
    }

    // DEPRECATED: Alte deleteComponent Funktion durch Modal-Version ersetzen
    window.deleteComponent = function(barcode, name) {
      showComponentDeleteModal(barcode, name);
    };

    async function updateStats() {
      try {
        console.log('üìä Aktualisiere Statistiken...');
        
        const totalComponents = allComponents.length;
        const storedComponents = allComponents.filter(c => c.schrank_id).length;
        const unstoredComponents = totalComponents - storedComponents;
        
        // Sichere Element-Updates
        const updateElement = (id, value) => {
          const el = document.getElementById(id);
          if (el) el.textContent = value;
        };
        
        updateElement('total-components', totalComponents);
        updateElement('stored-components', storedComponents);
        updateElement('unstored-components', unstoredComponents);
        
        // Schr√§nke laden
        try {
          const cabinets = await api.getCabinets();
          updateElement('total-cabinets', cabinets.length);
        } catch (error) {
          console.error('Fehler beim Laden der Schr√§nke:', error);
          updateElement('total-cabinets', '?');
        }
        
        console.log('‚úÖ Statistiken aktualisiert');
      } catch (error) {
        console.error('‚ùå Fehler beim Aktualisieren der Statistiken:', error);
      }
    }

    // URL-Parameter verarbeiten
    const urlParams = new URLSearchParams(window.location.search);
    const scanBarcode = urlParams.get('scan');
    const searchQuery = urlParams.get('search');
    
    // Nach Initialisierung URL-Parameter verarbeiten
    setTimeout(() => {
      if (searchQuery) {
        const globalSearch = document.getElementById('global-search');
        if (globalSearch) {
          globalSearch.value = searchQuery;
          handleGlobalSearch();
        }
      }
    }, 1000);
    
    // Error Handling
    window.addEventListener('error', function(e) {
      console.error('‚ùå Globaler Fehler:', e);
      if (e.message && e.message.includes('null')) {
        showMessage('Ein Element konnte nicht gefunden werden. Bitte lade die Seite neu.', 'warning');
      }
    });

    // Sensor Data Functions
    async function loadSensorData() {
      try {
        const locationSelect = document.getElementById('sensor-location-select');
        const location = locationSelect ? locationSelect.value : 'ssa';
        
        const response = await fetch(`/api/sensors/current/${location}`);
        if (!response.ok) return;
        
        const sensorData = await response.json();
        updateSensorDisplay(sensorData);
      } catch (error) {
        console.error('‚ùå Sensordaten Fehler:', error);
      }
    }
    
    function updateSensorDisplay(data) {
      try {
        // Temperature
        const tempValue = document.getElementById('temperature-value');
        if (tempValue) {
          if (data.temperature && data.temperature.temperature !== null && !isNaN(data.temperature.temperature)) {
            tempValue.textContent = `${data.temperature.temperature.toFixed(1)}¬∞C`;
          } else {
            tempValue.textContent = '--¬∞C';
          }
        }
        
        // Humidity
        const humValue = document.getElementById('humidity-value');
        if (humValue) {
          if (data.humidity && data.humidity.humidity !== null && !isNaN(data.humidity.humidity)) {
            humValue.textContent = `${data.humidity.humidity.toFixed(1)}%`;
          } else {
            humValue.textContent = '--%';
          }
        }
        
        // Debug-Info bei Fehler
        if (data.error || data.warning) {
          console.warn('‚ö†Ô∏è Sensordaten-Warnung:', data.errorMessage || data.warning);
        }
        
      } catch (error) {
        console.error('‚ùå Fehler beim Aktualisieren der Sensoranzeige:', error);
      }
    }
    
    
    function startSensorRefresh() {
      // Refresh every 30 seconds
      setInterval(async () => {
        await loadSensorData();
      }, 30000);
    }

    // Barcode Scanner Funktionen
    function setupBarcodeScanner() {
      const scanBtn = document.getElementById('scan-barcode-btn');
      const scannerModal = document.getElementById('scanner-modal');
      const closeScannerBtn = document.getElementById('close-scanner');
      const barcodeInput = document.getElementById('barcode-input');
      const processBarcodeBtn = document.getElementById('process-barcode');
      
      if (scanBtn) {
        scanBtn.addEventListener('click', () => {
          scannerModal.style.display = 'block';
          setTimeout(() => {
            if (barcodeInput) barcodeInput.focus();
          }, 100);
        });
      }
      
      if (closeScannerBtn) {
        closeScannerBtn.addEventListener('click', () => {
          scannerModal.style.display = 'none';
          if (barcodeInput) barcodeInput.value = '';
        });
      }
      
      if (barcodeInput) {
        barcodeInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            processBarcode();
          }
        });
      }
      
      if (processBarcodeBtn) {
        processBarcodeBtn.addEventListener('click', processBarcode);
      }
    }
    
    async function processBarcode() {
      const barcodeInput = document.getElementById('barcode-input');
      const scannerModal = document.getElementById('scanner-modal');
      
      if (!barcodeInput || !barcodeInput.value.trim()) {
        showMessage('Bitte geben Sie einen Barcode ein', 'error');
        return;
      }
      
      const barcode = barcodeInput.value.trim();
      
      try {
        // Check if it's a glue protocol (starts with GLUE-)
        if (barcode.startsWith('GLUE-')) {
          console.log('üîß Klebeprotokoll-Barcode erkannt:', barcode);
          
          const response = await fetch(`/api/glue-protocols/${barcode}`);
          if (response.ok) {
            const protocol = await response.json();
            showGlueProtocolDetails(protocol);
          } else {
            showMessage('Klebeprotokoll nicht gefunden', 'error');
          }
        } else {
          // It's a regular component barcode
          console.log('üì¶ Bauteil-Barcode erkannt:', barcode);
          
          const response = await fetch(`/api/bauteil/${barcode}`);
          if (response.ok) {
            const component = await response.json();
            // Navigate to edit component page
            window.location.href = `/edit-component.html?barcode=${encodeURIComponent(barcode)}`;
          } else {
            showMessage('Bauteil nicht gefunden', 'error');
          }
        }
        
        // Close scanner modal
        scannerModal.style.display = 'none';
        barcodeInput.value = '';
        
      } catch (error) {
        console.error('‚ùå Fehler beim Verarbeiten des Barcodes:', error);
        showMessage('Fehler beim Verarbeiten des Barcodes', 'error');
      }
    }
    
    function showGlueProtocolDetails(protocol) {
      const modalHtml = `
        <div id="glue-protocol-modal" class="modal" style="display: block;">
          <div class="modal-content">
            <div class="modal-header">
              <h3>Klebeprotokoll Details</h3>
              <button class="close-modal" onclick="closeGlueProtocolModal()">&times;</button>
            </div>
            <div class="modal-body">
              <div class="protocol-details">
                <div class="detail-row">
                  <strong>Klebe-Nummer:</strong> ${protocol.glue_number}
                </div>
                <div class="detail-row">
                  <strong>Bauteil:</strong> ${protocol.component_name}
                </div>
                <div class="detail-row">
                  <strong>Projekt:</strong> ${protocol.project}
                </div>
                <div class="detail-row">
                  <strong>Hardware Model:</strong> ${protocol.hardware_model || 'Nicht angegeben'}
                </div>
                <div class="detail-row">
                  <strong>Datum:</strong> ${new Date(protocol.glue_date).toLocaleDateString('de-DE')}
                </div>
                <div class="detail-row">
                  <strong>Kleber:</strong> ${protocol.glue_type}
                </div>
                <div class="detail-row">
                  <strong>Temperatur:</strong> ${protocol.temperature}¬∞C
                </div>
                <div class="detail-row">
                  <strong>Luftfeuchtigkeit:</strong> ${protocol.humidity}%
                </div>
                <div class="detail-row">
                  <strong>Sensor-Standort:</strong> ${protocol.sensor_location === 'ssa' ? 'Jarvis-Ecke' : protocol.sensor_location === 'int_up' ? 'Am Telefon' : 'Empore'}
                </div>
                <div class="detail-row">
                  <strong>Erstellt:</strong> ${new Date(protocol.created_at).toLocaleString('de-DE')}
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn secondary" onclick="closeGlueProtocolModal()">Schlie√üen</button>
            </div>
          </div>
        </div>
      `;
      
      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    window.closeGlueProtocolModal = function() {
      const modal = document.getElementById('glue-protocol-modal');
      if (modal) {
        modal.remove();
      }
    };
    
    // Globale Funktionen verf√ºgbar machen
    window.showComponentDeleteModal = showComponentDeleteModal;
    window.closeComponentDeleteModal = closeComponentDeleteModal;
    window.handleConfirmComponentDelete = handleConfirmComponentDelete;
  </script>

  <style>
    /* Zus√§tzliche Styles f√ºr clickable cards */
    .component-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .component-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .component-card:active {
      transform: translateY(0);
    }
    
    /* Stelle sicher, dass die Action Buttons √ºber dem Card-Click liegen */
    .component-actions {
      z-index: 10;
      position: relative;
    }
    
    .action-btn {
      z-index: 11;
      position: relative;
    }
    
    /* Visueller Hinweis dass die Karte klickbar ist */
    .component-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(74, 144, 226, 0.05), rgba(196, 214, 0, 0.05));
      opacity: 0;
      transition: opacity 0.2s ease;
      border-radius: inherit;
      pointer-events: none;
    }
    
    .component-card:hover::before {
      opacity: 1;
    }
    
    /* Navigation erweitert */
    .nav-left {
      display: flex;
      align-items: center;
      gap: 2rem;
      flex-grow: 1;
    }
    
    .lab-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .lab-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
      white-space: nowrap;
    }
    
    /* Mini Sensor Display in Header */
    .mini-sensors {
      display: flex;
      gap: 0.5rem;
    }
    
    .mini-sensor {
      font-size: 0.8rem;
      font-weight: 600;
      padding: 0.2rem 0.6rem;
      border-radius: 15px;
      background: var(--bg-light);
      border: 1px solid var(--border-color);
    }
    
    .mini-sensor.temp {
      color: #ff6b6b;
      border-color: #ff6b6b;
    }
    
    .mini-sensor.humid {
      color: #4ecdc4;
      border-color: #4ecdc4;
    }
    
    /* Location Dropdown Styling */
    .location-dropdown {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.3rem 0.8rem;
      outline: none;
      cursor: pointer;
      transition: border-color 0.2s ease;
    }
    
    .location-dropdown:hover {
      border-color: var(--primary-color);
    }
    
    .location-dropdown:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
    }

    /* Header Controls Styling */
    .header-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .filter-group label {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .filter-dropdown {
      font-size: 0.9rem;
      color: var(--text-primary);
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      outline: none;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 150px;
    }

    .filter-dropdown:hover {
      border-color: var(--primary-color);
    }

    .filter-dropdown:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
    }
    
    @media (max-width: 768px) {
      .nav-left {
        gap: 1rem;
      }
      
      .lab-name {
        display: none;
      }
      
      .mini-sensors {
        gap: 0.25rem;
      }
      
      .mini-sensor {
        font-size: 0.75rem;
        padding: 0.15rem 0.4rem;
      }

      /* Scanner Button */
      .scan-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .scan-btn:hover {
        background: #218838;
        transform: translateY(-1px);
      }

      .scan-btn svg {
        width: 16px;
        height: 16px;
      }

      /* Scanner Modal */
      .scanner-modal-content {
        max-width: 500px;
      }

      .scanner-body {
        padding: 1.5rem;
      }

      .scanner-input-section {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .scanner-input-section label {
        font-weight: 500;
        color: var(--text-primary);
      }

      .scanner-input-section input {
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 1rem;
      }

      .scanner-input-section input:focus {
        outline: none;
        border-color: #4a90e2;
        box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
      }

      .scanner-instructions {
        background: var(--bg-light);
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #4a90e2;
      }

      .scanner-types {
        margin-top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .scanner-type {
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      /* Glue Protocol Details */
      .protocol-details {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem;
        background: var(--bg-light);
        border-radius: 4px;
      }

      .detail-row strong {
        color: var(--text-primary);
        min-width: 140px;
      }

      .header-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
      }

      .filter-group {
        flex-direction: column;
        align-items: stretch;
        gap: 0.25rem;
      }

      .filter-dropdown {
        min-width: auto;
        width: 100%;
      }
    }
  </style>
</body>
</html>
