<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WeaselParts - Bauteil bearbeiten</title>
  <link rel="stylesheet" href="/css/modern-styles.css">
  <!-- Page Transitions -->
  <script src="/js/page-transitions.js"></script>
  <!-- Modal Animations -->
  <script src="/js/modal-animations.js"></script>
</head>
<body class="page-add-component">

<div class="modern-container">
  <!-- Modern Header -->
  <header class="modern-header">
    <nav class="modern-nav">
      <a href="/" class="modern-logo">
        <img src="/images/weasel-svgrepo-com.svg" alt="WeaselParts">
        <span>WeaselParts</span>
      </a>
      
      <!-- Search Bar -->
      <div class="modern-search">
        <input type="text" placeholder="Bauteile suchen..." id="global-search">
      </div>
      
      <!-- Sensor Data -->
      <div class="modern-sensors">
        <div class="modern-sensor temp" id="temperature-value">--°C</div>
        <div class="modern-sensor humid" id="humidity-value">--%</div>
        <select class="modern-select" id="sensor-location-select" style="width: auto; padding: 4px 8px;">
          <option value="ssa">Jarvis-Ecke</option>
          <option value="int_up">Am Telefon</option>
          <option value="emp">Empore</option>
        </select>
      </div>
      
      <!-- Navigation Buttons -->
      <div class="modern-nav-buttons">
        <button class="modern-nav-btn" id="add-component-nav-btn" title="Neues Bauteil">
          <img src="/images/button_add_component.png" alt="Neues Bauteil">
        </button>
        <button class="modern-nav-btn" id="manage-cabinets-nav-btn" title="Schränke verwalten">
          <img src="/images/button_manage_cabinet.png" alt="Schränke">
        </button>
        <a href="/ICD.html" class="modern-nav-btn" title="ICD">
          <img src="/images/button_icd.png" alt="ICD">
        </a>
        <a href="/lab-overview.html" class="modern-nav-btn" title="Labor-Übersicht">
          <img src="/images/button_lab_overview.png" alt="Labor">
        </a>
        <a href="/glue-protocol.html" class="modern-nav-btn" title="Klebeprotokoll">
          <img src="/images/button_glue_protocol.png" alt="Kleben">
        </a>
        <a href="/settings.html" class="modern-nav-btn" title="Einstellungen">
          <img src="/images/button_settings.png" alt="Settings">
        </a>
      </div>
    </nav>
  </header>

  <!-- Split Screen Layout -->
  <div class="modern-wrapper">
    <!-- Content Panel - Left Side 70% -->
    <div class="content-panel">
      <div class="modern-content">
        
        <!-- Page Header -->
        <div class="modern-page-header">
          <h1 class="modern-title">Bauteil bearbeiten</h1>
        </div>

        <!-- Component Name -->
        <h2 id="component-title" style="font-size: 1.5rem; font-weight: 700; margin: 0 0 var(--space-lg) 0; text-align: left;">Lädt...</h2>
        
        <!-- Component Header -->
        <div class="modern-card" style="margin-bottom: var(--space-xl);">
          <!-- Barcode und Bild nebeneinander -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-xl); align-items: center;">
            <!-- Links: Strichcode -->
            <div style="text-align: center;">
              <div id="barcode-image">
                <!-- Strichcode wird hier angezeigt -->
              </div>
            </div>
            
            <!-- Rechts: Aktuelles Bild -->
            <div style="text-align: center;">
              <div id="current-image-container">
                <!-- Wird dynamisch gefüllt -->
              </div>
            </div>
          </div>
        </div>

        <!-- Edit Form -->
        <form id="edit-component-form" enctype="multipart/form-data">
          <input type="hidden" id="original-barcode" name="original-barcode">

          <!-- Enhanced Image Upload with Camera Support -->
          <div class="modern-form-group">
            <label class="modern-label">Neues Bild (optional):</label>
            <div class="image-upload-container" style="margin-top: var(--space-sm);">
              <!-- Tab Navigation -->
              <div style="display: flex; border-bottom: 1px solid var(--gray-200); margin-bottom: var(--space-md);">
                <button type="button" class="tab-button active" data-tab="upload" style="padding: var(--space-sm) var(--space-md); border: none; background: transparent; cursor: pointer; border-bottom: 2px solid transparent;">
                  <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: var(--space-xs);">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                  </svg>
                  Datei hochladen
                </button>
                <button type="button" class="tab-button" data-tab="camera" style="padding: var(--space-sm) var(--space-md); border: none; background: transparent; cursor: pointer; border-bottom: 2px solid transparent;">
                  <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: var(--space-xs);">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                  Foto aufnehmen
                </button>
              </div>

              <!-- Upload Tab Content -->
              <div id="upload-tab" class="tab-content active">
                <div class="modern-image-container" id="image-upload-area" style="cursor: pointer;">
                  <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="60" height="60">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                  </svg>
                  <p style="margin: var(--space-md) 0;">Neues Bild hochladen</p>
                  <span style="font-size: 0.875rem; color: var(--gray-500);">Klicken oder Datei hierher ziehen</span>
                </div>
                <input type="file" id="component-image" name="image" accept="image/*" style="display: none;">
              </div>

              <!-- Camera Tab Content -->
              <div id="camera-tab" class="tab-content" style="display: none;">
                <div class="camera-container">
                  <div class="camera-preview" style="position: relative; background: var(--gray-50); border-radius: var(--radius-md); overflow: hidden; height: 300px;">
                    <video id="camera-video" class="camera-video" autoplay muted playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
                    <div class="camera-placeholder" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
                      <svg width="80" height="80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      </svg>
                      <h4 style="margin: var(--space-md) 0 var(--space-sm) 0;">Kamera bereit</h4>
                      <p>Klicke auf "Kamera starten" um ein neues Foto aufzunehmen</p>
                    </div>
                    <div class="camera-status" style="position: absolute; top: var(--space-md); right: var(--space-md); background: rgba(0,0,0,0.7); color: white; padding: var(--space-xs) var(--space-sm); border-radius: var(--radius-sm); font-size: 0.875rem;">
                      <div class="camera-status-dot" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #FF6B6B; margin-right: var(--space-xs);"></div>
                      Kamera gestoppt
                    </div>
                  </div>
                  <div class="camera-controls" style="display: flex; gap: var(--space-sm); margin-top: var(--space-md);">
                    <button type="button" class="modern-btn modern-btn-secondary camera-btn start" data-action="start">
                      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      Kamera starten
                    </button>
                    <button type="button" class="modern-btn modern-btn-primary camera-btn capture" data-action="capture" disabled>
                      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      </svg>
                      Foto aufnehmen
                    </button>
                    <button type="button" class="modern-btn modern-btn-secondary camera-btn stop" data-action="stop" disabled>
                      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10h6v4H9z"></path>
                      </svg>
                      Kamera stoppen
                    </button>
                    <button type="button" class="modern-btn modern-btn-secondary camera-btn switch" data-action="switch" disabled>
                      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                      </svg>
                      Kamera wechseln
                    </button>
                  </div>
                  <canvas id="camera-canvas" style="display: none;"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Image Preview -->
          <div id="image-preview-container" class="modern-form-group" style="display: none;">
            <label class="modern-label">Bild-Vorschau:</label>
            <div id="image-preview" class="modern-image-container" style="margin-top: var(--space-sm);">
              <!-- Preview wird hier angezeigt -->
            </div>
            <button type="button" id="remove-image" class="modern-btn modern-btn-secondary" style="margin-top: var(--space-sm);">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
              Bild entfernen
            </button>
          </div>

          <!-- Form Grid - Left and Right Columns -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); margin-bottom: var(--space-xl);">
            <div>
              <div class="modern-form-group">
                <label class="modern-label" for="project">PROJECT*:</label>
                <input type="text" id="project" name="project" required class="modern-input">
              </div>
              
              <div class="modern-form-group">
                <label class="modern-label" for="identification_number">IDENTIFICATION NUMBER:</label>
                <input type="text" id="identification_number" name="identification_number" class="modern-input">
              </div>
            </div>
            
            <div>
              <div class="modern-form-group">
                <label class="modern-label" for="responsible_engineer">RESPONSIBLE ENGINEER*:</label>
                <input type="text" id="responsible_engineer" name="responsible_engineer" required class="modern-input">
              </div>
              
              <div class="modern-form-group">
                <label class="modern-label" for="equipment_name">EQUIPMENT NAME*:</label>
                <input type="text" id="equipment_name" name="equipment_name" required class="modern-input">
              </div>
            </div>
          </div>

          <!-- Basic Information -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); margin-bottom: var(--space-xl);">
            <div class="modern-form-group">
              <label class="modern-label" for="name">Bauteil-Name:</label>
              <input type="text" id="name" name="name" class="modern-input">
            </div>

            <div class="modern-form-group">
              <label class="modern-label" for="schrank">Schrank:</label>
              <select id="schrank" name="schrank_id" class="modern-select">
                <option value="">Schrank auswählen...</option>
              </select>
            </div>
          </div>

          <div class="modern-form-group">
            <label class="modern-label" for="beschreibung">Beschreibung:</label>
            <textarea id="beschreibung" name="beschreibung" rows="4" class="modern-textarea"></textarea>
          </div>

          <!-- Form Actions -->
          <div style="display: flex; gap: var(--space-md); margin-top: var(--space-2xl);">
            <button type="submit" class="modern-btn modern-btn-primary">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              Änderungen speichern
            </button>
            <button type="button" class="modern-btn modern-btn-secondary" onclick="window.history.back()">
              Abbrechen
            </button>
            <button class="modern-btn" id="delete-btn" style="background: #FF6B6B; border-color: #FF6B6B; color: white;">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
              Löschen
            </button>
          </div>
        </form>

      </div>
    </div>
    
    <!-- Background Panel - Right Side 30% -->
    <div class="background-panel">
      <!-- Storage Info Section -->
      <div style="position: absolute; top: var(--space-xl); right: var(--space-xl); left: var(--space-xl); z-index: 10;">
        <div class="modern-card" style="margin-bottom: var(--space-lg);">
          <h3 style="display: flex; align-items: center; gap: var(--space-sm); margin: 0 0 var(--space-md) 0; font-size: 1.125rem; font-weight: 600;">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            </svg>
            Lagerort
          </h3>
          <div id="storage-info" style="font-size: 0.875rem;">
            <!-- Wird dynamisch gefüllt -->
          </div>
        </div>

        <!-- Historical Records Preview -->
        <div class="modern-card" style="margin-bottom: var(--space-lg);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
            <h3 style="display: flex; align-items: center; gap: var(--space-sm); margin: 0; font-size: 1.125rem; font-weight: 600;">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Historical Records
            </h3>
            <button class="modern-action-btn" id="view-all-records" title="Alle Historical Records anzeigen" onclick="openHistoricalRecords()">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
              </svg>
            </button>
          </div>
          <div id="records-preview" style="font-size: 0.875rem;">
            <div style="color: var(--gray-500);">Lade Historical Records...</div>
          </div>
        </div>

        <!-- Environmental History Display -->
        <div class="modern-card" style="margin-bottom: var(--space-lg);">
          <h4 style="display: flex; align-items: center; gap: var(--space-sm); margin: 0 0 var(--space-md) 0; font-size: 1rem; font-weight: 600;">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            Umgebungshistorie (6 Monate)
          </h4>
          
          <!-- Temperature Timeline -->
          <div style="margin-bottom: var(--space-md); padding: var(--space-sm); background: var(--gray-50); border-radius: var(--radius-md);">
            <div style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-xs);">
              <div style="color: #ff6b6b;">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 2v18a4 4 0 004-4h0a4 4 0 00-4-4V2z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14h4"></path>
                </svg>
              </div>
              <span style="font-weight: 600; font-size: 0.875rem;">Temperatur-Verlauf</span>
            </div>
            <div id="temperature-timeline" style="font-size: 0.8rem; color: var(--gray-600);">
              <div>Lädt...</div>
            </div>
          </div>

          <!-- Humidity Timeline -->
          <div style="padding: var(--space-sm); background: var(--gray-50); border-radius: var(--radius-md);">
            <div style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-xs);">
              <div style="color: #4ecdc4;">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 22c4.97 0 9-4.03 9-9-4.5-4.5-9-15-9-15s-4.5 10.5-9 15c0 4.97 4.03 9 9 9z"></path>
                </svg>
              </div>
              <span style="font-weight: 600; font-size: 0.875rem;">Feuchtigkeits-Verlauf</span>
            </div>
            <div id="humidity-timeline" style="font-size: 0.8rem; color: var(--gray-600);">
              <div>Lädt...</div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="modern-card">
          <h4 style="margin: 0 0 var(--space-md) 0; font-size: 1rem; font-weight: 600;">Schnellaktionen</h4>
          <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
            <button class="modern-btn modern-btn-secondary" onclick="printComponentLabel()" style="justify-content: flex-start;">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
              </svg>
              Barcode drucken
            </button>
            <button class="modern-btn modern-btn-secondary" onclick="copyComponentInfo()" style="justify-content: flex-start;">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
              Info kopieren
            </button>
            <button class="modern-btn modern-btn-secondary" onclick="exportComponentData()" style="justify-content: flex-start;">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Als CSV exportieren
            </button>
          </div>
        </div>
      </div>
      
      <img src="/images/background_icon_add_component.png" alt="Edit Component Icon" class="background-icon">
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-confirmation-modal" class="modern-modal">
  <div class="modern-modal-content" style="max-width: 500px;">
    <div class="modern-modal-header modal-titlebar">
      <h3>Bauteil löschen</h3>
      <button class="modal-close-btn" id="close-delete-modal">✕</button>
    </div>
    
    <div class="modern-modal-body" style="text-align: center;">
      <div style="margin-bottom: var(--space-lg);">
        <svg width="60" height="60" fill="none" stroke="#FF6B6B" viewBox="0 0 24 24" style="margin: 0 auto;">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
        </svg>
      </div>
      
      <div style="margin-bottom: var(--space-xl);">
        <p style="margin-bottom: var(--space-md); font-size: 1.125rem;" id="component-delete-message">Möchten Sie dieses Bauteil wirklich löschen?</p>
        <div style="background: #FFF3F3; border: 1px solid #FFB3B3; border-radius: var(--radius-md); padding: var(--space-md);" id="component-delete-details">
          <!-- Wird dynamisch gefüllt -->
        </div>
        <div style="background: #FFF3F3; border: 1px solid #FFB3B3; border-radius: var(--radius-md); padding: var(--space-md); margin-top: var(--space-md);">
          <strong>Achtung:</strong> Diese Aktion kann nicht rückgängig gemacht werden.
        </div>
      </div>
    </div>
      
    <div class="modern-modal-footer">
      <button class="modern-btn modern-btn-secondary" id="cancel-delete">Abbrechen</button>
      <button class="modern-btn modern-btn-primary" id="confirm-delete" style="background: #FF6B6B; border-color: #FF6B6B;">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
        </svg>
        Löschen
      </button>
    </div>
  </div>
</div>

<!-- Storage Selection Modal -->
<div id="storage-selection-modal" class="modern-modal">
  <div class="modern-modal-content" style="max-width: 700px;">
    <div class="modern-modal-header modal-titlebar">
      <h3>Schrank für Einlagerung wählen</h3>
      <button class="modal-close-btn" id="close-storage-selection">✕</button>
    </div>
    
    <div class="modern-modal-body">
      <div class="modern-card" style="margin-bottom: var(--space-lg);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
          <h3 id="storage-component-name" style="margin: 0; font-size: 1.25rem;">Komponente</h3>
          <span class="modern-badge modern-badge-warning">Nicht eingelagert</span>
        </div>
        
        <div style="display: flex; gap: var(--space-lg);">
          <div id="storage-component-image" style="width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; background: var(--gray-50); border-radius: var(--radius-md);">
            <div>📦</div>
          </div>
          
          <div id="storage-component-info" style="flex: 1; font-size: 0.875rem;">
            <!-- Wird dynamisch gefüllt -->
          </div>
        </div>
      </div>
      
      <div class="modern-form-group">
        <label class="modern-label" for="storage-cabinet-select">Schrank auswählen:</label>
        <select id="storage-cabinet-select" class="modern-select">
          <option value="">Bitte wählen...</option>
        </select>
      </div>
    </div>
    
    <div class="modern-modal-footer">
      <button class="modern-btn modern-btn-secondary" id="cancel-storage-selection">Abbrechen</button>
      <button class="modern-btn modern-btn-primary" id="confirm-storage-selection">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        Einlagern
      </button>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<!-- Scripts -->
<script src="/js/api.js"></script>
<script src="/js/common.js"></script>
<script src="/js/camera.js"></script>
<script src="/js/print-automation.js"></script>

<script>
// Global variables
let currentComponent = null;
let cameraActive = false;
let currentStream = null;
let currentCameraIndex = 0;
let availableCameras = [];

document.addEventListener('DOMContentLoaded', async () => {
  console.log('🚀 Edit Component page initializing...');
  
  // Setup navigation
  setupNavigation();
  
  // Get barcode from URL
  const urlParams = new URLSearchParams(window.location.search);
  const barcode = urlParams.get('barcode');
  
  if (!barcode) {
    showMessage('Kein Barcode angegeben', 'error');
    return;
  }
  
  // Load component data
  await loadComponent(barcode);
  
  // Setup form handlers
  setupFormHandlers();
  setupImageUpload();
  setupCameraHandlers();
  
  console.log('✅ Edit Component page initialized');
});

// Setup Navigation
function setupNavigation() {
  const addBtn = document.getElementById('add-component-nav-btn');
  if (addBtn) {
    addBtn.addEventListener('click', () => {
      window.location.href = '/add-component.html';
    });
  }

  const manageCabinetsBtn = document.getElementById('manage-cabinets-nav-btn');
  if (manageCabinetsBtn) {
    manageCabinetsBtn.addEventListener('click', () => {
      window.location.href = '/manage-cabinets.html';
    });
  }
  
  const globalSearch = document.getElementById('global-search');
  if (globalSearch) {
    globalSearch.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && e.target.value.trim()) {
        window.location.href = `/?search=${encodeURIComponent(e.target.value)}`;
      }
    });
  }
}

// Load component data
async function loadComponent(barcode) {
  try {
    const component = await api.getComponent(barcode);
    currentComponent = component;
    
    // Populate form
    document.getElementById('original-barcode').value = component.barcode || '';
    document.getElementById('name').value = component.name || '';
    document.getElementById('beschreibung').value = component.beschreibung || '';
    document.getElementById('project').value = component.project || '';
    document.getElementById('identification_number').value = component.identification_number || '';
    document.getElementById('responsible_engineer').value = component.responsible_engineer || '';
    document.getElementById('equipment_name').value = component.equipment_name || '';
    
    // Update header
    document.getElementById('component-title').textContent = component.name || 'Unbenanntes Bauteil';
    
    // Generate barcode image
    const barcodeContainer = document.getElementById('barcode-image');
    if (component.barcode) {
      barcodeContainer.innerHTML = `
        <img src="https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(component.barcode)}&code=Code128&translate-esc=on&unit=Fit&dpi=150&imagetype=Gif" 
             alt="Barcode ${component.barcode}" 
             style="width: 100%; max-width: 300px; height: auto; border: 1px solid var(--gray-200);">
      `;
    }
    
    // Load cabinets
    await loadCabinets();
    document.getElementById('schrank').value = component.schrank_id || '';
    
    // Display current image
    displayCurrentImage(component);
    
    // Update storage info
    updateStorageInfo(component);
    
    // Load additional data
    await loadHistoricalRecordsPreview(component.barcode);
    await loadEnvironmentalHistory(component.barcode);
    
  } catch (error) {
    console.error('Error loading component:', error);
    showMessage('Fehler beim Laden des Bauteils', 'error');
  }
}

// Display current image
function displayCurrentImage(component) {
  const container = document.getElementById('current-image-container');
  
  if (component.image_url) {
    container.innerHTML = `
      <div class="modern-image-container" style="max-width: 300px; position: relative;">
        <img src="${component.image_url}" alt="${component.name}" style="width: 100%; height: auto; object-fit: cover;">
        <button type="button" onclick="removeCurrentImage()" class="image-delete-btn" title="Bild entfernen" 
                style="position: absolute; top: 8px; right: 8px; width: 32px; height: 32px; background: rgba(255, 107, 107, 0.9); border: none; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"
                onmouseover="this.style.background='rgba(255, 107, 107, 1)'; this.style.transform='scale(1.1)'"
                onmouseout="this.style.background='rgba(255, 107, 107, 0.9)'; this.style.transform='scale(1)'">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
        </button>
      </div>
    `;
  } else {
    container.innerHTML = `
      <div class="modern-image-container">
        <svg width="60" height="60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
        <p>Kein Bild vorhanden</p>
      </div>
    `;
  }
}

// Update storage info
function updateStorageInfo(component) {
  const storageInfo = document.getElementById('storage-info');
  
  if (component.schrank_name) {
    storageInfo.innerHTML = `
      <p style="color: var(--table-header-success); font-weight: 600; margin-bottom: var(--space-sm);">✓ Eingelagert</p>
      <p style="margin-bottom: var(--space-xs);"><strong>Schrank:</strong> ${component.schrank_name}</p>
      <p style="margin-bottom: var(--space-md);"><strong>Position:</strong> ${component.position || 'Nicht angegeben'}</p>
      <button class="modern-btn modern-btn-secondary" onclick="removeFromStorage()" style="width: 100%;">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
        </svg>
        Auslagern
      </button>
    `;
  } else {
    storageInfo.innerHTML = `
      <p style="color: var(--gray-500); margin-bottom: var(--space-md);">⚠️ Nicht eingelagert</p>
      <button class="modern-btn modern-btn-primary" onclick="showStorageOptions()" style="width: 100%;">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18M13 8v8a3 3 0 01-3 3H6a3 3 0 01-3-3V8a3 3 0 013-3h4a3 3 0 013 3z"></path>
        </svg>
        Einlagern
      </button>
    `;
  }
}

// Load cabinets for dropdown
async function loadCabinets() {
  try {
    const cabinets = await api.getCabinets();
    const select = document.getElementById('schrank');
    const storageSelect = document.getElementById('storage-cabinet-select');
    
    select.innerHTML = '<option value="">Schrank auswählen...</option>';
    if (storageSelect) storageSelect.innerHTML = '<option value="">Bitte wählen...</option>';
    
    cabinets.forEach(cabinet => {
      const option = document.createElement('option');
      option.value = cabinet.id;
      option.textContent = cabinet.name;
      select.appendChild(option);
      
      if (storageSelect) {
        const option2 = document.createElement('option');
        option2.value = cabinet.id;
        option2.textContent = cabinet.name;
        storageSelect.appendChild(option2);
      }
    });
  } catch (error) {
    console.error('Error loading cabinets:', error);
  }
}

// Setup form handlers
function setupFormHandlers() {
  const form = document.getElementById('edit-component-form');
  form.addEventListener('submit', handleFormSubmit);
  
  const deleteBtn = document.getElementById('delete-btn');
  deleteBtn.addEventListener('click', showDeleteConfirmation);
  
  // Modal handlers
  document.getElementById('close-delete-modal').addEventListener('click', () => {
    closeModal('delete-confirmation-modal');
  });
  
  document.getElementById('cancel-delete').addEventListener('click', () => {
    closeModal('delete-confirmation-modal');
  });
  
  document.getElementById('confirm-delete').addEventListener('click', handleDelete);
  
  // Storage modal handlers
  const closeStorageBtn = document.getElementById('close-storage-selection');
  if (closeStorageBtn) {
    closeStorageBtn.addEventListener('click', () => {
      closeModal('storage-selection-modal');
    });
  }
  
  const cancelStorageBtn = document.getElementById('cancel-storage-selection');
  if (cancelStorageBtn) {
    cancelStorageBtn.addEventListener('click', () => {
      closeModal('storage-selection-modal');
    });
  }
  
  const confirmStorageBtn = document.getElementById('confirm-storage-selection');
  if (confirmStorageBtn) {
    confirmStorageBtn.addEventListener('click', handleStorageSelection);
  }
}

// Handle form submission
async function handleFormSubmit(e) {
  e.preventDefault();
  
  try {
    const formData = new FormData(e.target);
    
    // Add image if selected
    const imageInput = document.getElementById('component-image');
    if (imageInput.files.length > 0) {
      formData.set('image', imageInput.files[0]);
    }
    
    await api.updateComponent(currentComponent.barcode, formData);
    
    showMessage('Bauteil erfolgreich aktualisiert!', 'success');
    
    // Reload component data
    setTimeout(async () => {
      await loadComponent(currentComponent.barcode);
    }, 1000);
    
  } catch (error) {
    console.error('Error updating component:', error);
    showMessage('Fehler beim Aktualisieren des Bauteils', 'error');
  }
}

// Show delete confirmation
function showDeleteConfirmation() {
  if (!currentComponent) return;
  
  document.getElementById('component-delete-message').textContent = 
    `Möchten Sie das Bauteil "${currentComponent.name || currentComponent.barcode}" wirklich löschen?`;
    
  document.getElementById('component-delete-details').innerHTML = `
    <p style="margin: 0;"><strong>Barcode:</strong> ${currentComponent.barcode}</p>
    <p style="margin: var(--space-xs) 0;"><strong>Projekt:</strong> ${currentComponent.project || '-'}</p>
    <p style="margin: 0;"><strong>Schrank:</strong> ${currentComponent.schrank_name || 'Nicht eingelagert'}</p>
  `;
  
  openModal('delete-confirmation-modal');
}

// Handle delete
async function handleDelete() {
  try {
    await api.deleteComponent(currentComponent.barcode);
    
    showMessage('Bauteil erfolgreich gelöscht!', 'success');
    
    closeModal('delete-confirmation-modal');
    
    // Redirect to main page after delete
    setTimeout(() => {
      window.location.href = '/';
    }, 1500);
    
  } catch (error) {
    console.error('Error deleting component:', error);
    showMessage('Fehler beim Löschen des Bauteils', 'error');
  }
}

// Show storage options
function showStorageOptions() {
  if (!currentComponent) return;
  
  document.getElementById('storage-component-name').textContent = currentComponent.name || 'Unbenanntes Bauteil';
  document.getElementById('storage-component-info').innerHTML = `
    <p style="margin: 0;"><strong>Barcode:</strong> ${currentComponent.barcode}</p>
    <p style="margin: var(--space-xs) 0;"><strong>Projekt:</strong> ${currentComponent.project || '-'}</p>
    <p style="margin: 0;"><strong>Verantwortlicher:</strong> ${currentComponent.responsible_engineer || '-'}</p>
  `;
  
  if (currentComponent.image_url) {
    document.getElementById('storage-component-image').innerHTML = `
      <img src="${currentComponent.image_url}" alt="${currentComponent.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-md);">
    `;
  }
  
  openModal('storage-selection-modal');
}

// Handle storage selection
async function handleStorageSelection() {
  const cabinetId = document.getElementById('storage-cabinet-select').value;
  
  if (!cabinetId) {
    showMessage('Bitte wählen Sie einen Schrank aus', 'warning');
    return;
  }
  
  try {
    await storeComponentInCabinet(currentComponent.barcode, cabinetId);
    closeModal('storage-selection-modal');
    
    // Reload component data
    await loadComponent(currentComponent.barcode);
    
  } catch (error) {
    showMessage('Fehler beim Einlagern des Bauteils', 'error');
  }
}

// Store component in cabinet
async function storeComponentInCabinet(barcode, cabinetId) {
  const response = await fetch(`/api/components/${barcode}/store`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ schrank_id: cabinetId })
  });
  
  if (!response.ok) throw new Error('Storage failed');
  
  showMessage('Bauteil erfolgreich eingelagert!', 'success');
  return response.json();
}

// Remove from storage
async function removeFromStorage() {
  if (!currentComponent || !confirm('Bauteil wirklich auslagern?')) return;
  
  try {
    const response = await fetch(`/api/components/${currentComponent.barcode}/store`, {
      method: 'DELETE'
    });
    
    if (!response.ok) throw new Error('Remove from storage failed');
    
    showMessage('Bauteil erfolgreich ausgelagert!', 'success');
    
    // Reload component data
    await loadComponent(currentComponent.barcode);
    
  } catch (error) {
    console.error('Error removing from storage:', error);
    showMessage('Fehler beim Auslagern des Bauteils', 'error');
  }
}

// Modal helper functions
function openModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.add('active');
    modal.style.display = 'flex';
  }
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.remove('active');
    modal.style.display = 'none';
  }
}

// Setup image upload
function setupImageUpload() {
  const uploadArea = document.getElementById('image-upload-area');
  const imageInput = document.getElementById('component-image');
  const removeBtn = document.getElementById('remove-image');
  
  // Click to upload
  uploadArea.addEventListener('click', () => {
    imageInput.click();
  });
  
  // File selection
  imageInput.addEventListener('change', handleImageSelection);
  
  // Remove image
  removeBtn.addEventListener('click', removeImage);
  
  // Tab switching
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
      const tab = button.getAttribute('data-tab');
      switchTab(tab);
    });
  });
  
  // Drag and drop
  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = 'var(--table-header-primary)';
  });
  
  uploadArea.addEventListener('dragleave', () => {
    uploadArea.style.borderColor = 'var(--gray-300)';
  });
  
  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = 'var(--gray-300)';
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleImageFile(files[0]);
    }
  });
}

// Switch tabs
function switchTab(tab) {
  // Update buttons
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('active');
    btn.style.borderBottomColor = 'transparent';
  });
  
  document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
  document.querySelector(`[data-tab="${tab}"]`).style.borderBottomColor = 'var(--table-header-primary)';
  
  // Update content
  document.querySelectorAll('.tab-content').forEach(content => {
    content.style.display = 'none';
  });
  
  document.getElementById(`${tab}-tab`).style.display = 'block';
}

// Handle image selection
function handleImageSelection(e) {
  const file = e.target.files[0];
  if (file) {
    handleImageFile(file);
  }
}

// Handle image file
function handleImageFile(file) {
  if (!file.type.startsWith('image/')) {
    showMessage('Bitte wählen Sie eine Bilddatei aus', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = (e) => {
    showImagePreview(e.target.result, file.name);
  };
  reader.readAsDataURL(file);
}

// Show image preview
function showImagePreview(src, filename) {
  const container = document.getElementById('image-preview-container');
  const preview = document.getElementById('image-preview');
  
  preview.innerHTML = `
    <img src="${src}" alt="${filename}" style="width: 100%; height: 200px; object-fit: cover;">
    <p style="margin-top: var(--space-sm); font-size: 0.875rem; color: var(--gray-600);">${filename}</p>
  `;
  
  container.style.display = 'block';
}

// Remove image
function removeImage() {
  document.getElementById('component-image').value = '';
  document.getElementById('image-preview-container').style.display = 'none';
  document.getElementById('image-preview').innerHTML = '';
}

// Remove current image
function removeCurrentImage() {
  if (confirm('Aktuelles Bild wirklich entfernen?')) {
    const currentImageContainer = document.getElementById('current-image-container');
    if (currentImageContainer) {
      currentImageContainer.innerHTML = `
        <div class="modern-image-container">
          <svg width="60" height="60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <p>Kein Bild vorhanden</p>
        </div>
      `;
    }
    showMessage('Bild entfernt. Speichere das Formular um die Änderung zu übernehmen.', 'info');
  }
}

// Setup camera handlers
function setupCameraHandlers() {
  document.querySelectorAll('.camera-btn').forEach(btn => {
    btn.addEventListener('click', handleCameraAction);
  });
}

// Handle camera actions
async function handleCameraAction(e) {
  const action = e.currentTarget.getAttribute('data-action');
  
  switch(action) {
    case 'start':
      await startCamera();
      break;
    case 'capture':
      capturePhoto();
      break;
    case 'stop':
      stopCamera();
      break;
    case 'switch':
      await switchCamera();
      break;
  }
}

// Start camera
async function startCamera() {
  try {
    // Get available cameras
    const devices = await navigator.mediaDevices.enumerateDevices();
    availableCameras = devices.filter(device => device.kind === 'videoinput');
    
    if (availableCameras.length === 0) {
      showMessage('Keine Kamera gefunden', 'error');
      return;
    }
    
    const constraints = {
      video: {
        deviceId: availableCameras[currentCameraIndex].deviceId
      }
    };
    
    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
    
    const video = document.getElementById('camera-video');
    const placeholder = document.querySelector('.camera-placeholder');
    const statusText = document.querySelector('.camera-status');
    const statusDot = document.querySelector('.camera-status-dot');
    
    video.srcObject = currentStream;
    video.style.display = 'block';
    placeholder.style.display = 'none';
    
    // Update UI
    statusText.textContent = 'Kamera aktiv';
    statusDot.style.background = '#4CAF50';
    
    // Update buttons
    document.querySelector('[data-action="start"]').disabled = true;
    document.querySelector('[data-action="capture"]').disabled = false;
    document.querySelector('[data-action="stop"]').disabled = false;
    document.querySelector('[data-action="switch"]').disabled = availableCameras.length <= 1;
    
    cameraActive = true;
    
  } catch (error) {
    console.error('Error starting camera:', error);
    showMessage('Kamera konnte nicht gestartet werden', 'error');
  }
}

// Capture photo
function capturePhoto() {
  const video = document.getElementById('camera-video');
  const canvas = document.getElementById('camera-canvas');
  const ctx = canvas.getContext('2d');
  
  // Set canvas size to video size
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  
  // Draw video frame to canvas
  ctx.drawImage(video, 0, 0);
  
  // Convert to blob and create file
  canvas.toBlob((blob) => {
    const file = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });
    
    // Create file input with captured image
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(file);
    document.getElementById('component-image').files = dataTransfer.files;
    
    // Show preview
    const dataUrl = canvas.toDataURL('image/jpeg');
    showImagePreview(dataUrl, 'camera-photo.jpg');
    
    // Switch to upload tab
    switchTab('upload');
    
    showMessage('Foto aufgenommen!', 'success');
  }, 'image/jpeg', 0.9);
}

// Stop camera
function stopCamera() {
  if (currentStream) {
    currentStream.getTracks().forEach(track => track.stop());
    currentStream = null;
  }
  
  const video = document.getElementById('camera-video');
  const placeholder = document.querySelector('.camera-placeholder');
  const statusText = document.querySelector('.camera-status');
  const statusDot = document.querySelector('.camera-status-dot');
  
  video.style.display = 'none';
  placeholder.style.display = 'flex';
  
  // Update UI
  statusText.textContent = 'Kamera gestoppt';
  statusDot.style.background = '#FF6B6B';
  
  // Update buttons
  document.querySelector('[data-action="start"]').disabled = false;
  document.querySelector('[data-action="capture"]').disabled = true;
  document.querySelector('[data-action="stop"]').disabled = true;
  document.querySelector('[data-action="switch"]').disabled = true;
  
  cameraActive = false;
}

// Switch camera
async function switchCamera() {
  if (availableCameras.length <= 1) return;
  
  // Stop current camera
  if (currentStream) {
    currentStream.getTracks().forEach(track => track.stop());
  }
  
  // Switch to next camera
  currentCameraIndex = (currentCameraIndex + 1) % availableCameras.length;
  
  // Restart camera
  await startCamera();
}

// Quick Actions
function printComponentLabel() {
  if (!currentComponent) return;
  
  // Verwende die automatische Print-Funktion aus print-automation.js
  if (typeof autoPrintBarcode === 'function') {
    autoPrintBarcode(
      currentComponent.barcode, 
      currentComponent.name || 'Unbenannt',
      {
        labelSize: '19x51',
        dpi: 300,
        scale: 100
      }
    );
  } else {
    // Fallback
    const printUrl = `https://barcode.tec-it.com/barcode.ashx?data=${currentComponent.barcode}&code=Code128&translate-esc=on&unit=Fit&dpi=300&imagetype=Gif`;
    const printWindow = window.open(printUrl, '_blank');
    if (printWindow) {
      printWindow.onload = () => {
        printWindow.print();
      };
    }
  }
}

async function copyComponentInfo() {
  if (!currentComponent) return;
  
  const info = `
Barcode: ${currentComponent.barcode}
Name: ${currentComponent.name || 'Unbenannt'}
Projekt: ${currentComponent.project || '-'}
Verantwortlicher: ${currentComponent.responsible_engineer || '-'}
Gerätebezeichnung: ${currentComponent.equipment_name || '-'}
ID-Nummer: ${currentComponent.identification_number || '-'}
Schrank: ${currentComponent.schrank_name || 'Nicht eingelagert'}
  `.trim();
  
  try {
    await navigator.clipboard.writeText(info);
    showMessage('Bauteil-Informationen in Zwischenablage kopiert!', 'success');
  } catch (error) {
    showMessage('Kopieren fehlgeschlagen', 'error');
  }
}

function exportComponentData() {
  if (!currentComponent) return;
  
  const data = [{
    'Barcode': currentComponent.barcode,
    'Name': currentComponent.name || 'Unbenannt',
    'Projekt': currentComponent.project || '-',
    'Verantwortlicher': currentComponent.responsible_engineer || '-',
    'Gerätebezeichnung': currentComponent.equipment_name || '-',
    'ID-Nummer': currentComponent.identification_number || '-',
    'Schrank': currentComponent.schrank_name || 'Nicht eingelagert',
    'Beschreibung': currentComponent.beschreibung || '-'
  }];
  
  const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
  
  // Convert to CSV
  if (data.length === 0) return;
  
  const headers = Object.keys(data[0]);
  const csvContent = [
    headers.join(','),
    ...data.map(row => headers.map(header => {
      const value = row[header] || '';
      if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
        return `"${value.replace(/"/g, '""')}"`;
      }
      return value;
    }).join(','))
  ].join('\n');
  
  // Download CSV
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `weaselparts_${currentComponent.barcode}_${timestamp}.csv`;
  document.body.appendChild(a);
  a.click();
  window.URL.revokeObjectURL(url);
  document.body.removeChild(a);
  
  showMessage('CSV Export erfolgreich heruntergeladen', 'success');
}

// Historical Records Preview Functions
async function loadHistoricalRecordsPreview(barcode) {
  const previewContainer = document.getElementById('records-preview');
  if (!previewContainer) return;
  
  try {
    const response = await fetch(`/api/bauteil/${encodeURIComponent(barcode)}/activities`);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    const records = await response.json();
    displayRecordsPreview(records);
  } catch (error) {
    console.error('Fehler beim Laden der Historical Records:', error);
    previewContainer.innerHTML = '<div style="color: var(--gray-500);">Historical Records konnten nicht geladen werden</div>';
  }
}

function displayRecordsPreview(records) {
  const previewContainer = document.getElementById('records-preview');
  if (!previewContainer) return;
  
  if (!records || records.length === 0) {
    previewContainer.innerHTML = '<div style="color: var(--gray-500);">Noch keine Historical Records vorhanden</div>';
    return;
  }
  
  // Nur die letzten 3 Records anzeigen
  const recentRecords = records.slice(0, 3);
  
  previewContainer.innerHTML = recentRecords.map((record, index) => {
    const activities = getActivityNames(record);
    const formattedDate = record.date ? new Date(record.date).toLocaleDateString('de-DE') : 'Ohne Datum';
    const recordNumber = records.length - index;
    
    return `
      <div style="display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-xs); margin-bottom: var(--space-xs); background: var(--gray-50); border-radius: var(--radius-sm); cursor: pointer;" onclick="openHistoricalRecords()">
        <div style="background: var(--table-header-primary); color: white; padding: 2px 6px; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 600; min-width: 24px; text-align: center;">#${recordNumber}</div>
        <div style="flex: 1; min-width: 0;">
          <div style="font-weight: 600; margin-bottom: 2px;">${formattedDate}</div>
          <div style="font-size: 0.8rem; color: var(--gray-600); truncate: ellipsis; overflow: hidden; white-space: nowrap;">${activities}</div>
        </div>
        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </div>
    `;
  }).join('');
}

function getActivityNames(record) {
  const activities = [];
  if (record.activity_assy) activities.push('ASSY');
  if (record.activity_disassy) activities.push('DISASSY');
  if (record.activity_test) activities.push('TEST');
  if (record.activity_shpf) activities.push('SHPF');
  if (record.activity_insp) activities.push('INSP');
  if (record.activity_cln) activities.push('CLN');
  if (record.activity_smpl) activities.push('SMPL');
  if (record.activity_cal) activities.push('CAL');
  if (record.activity_hndl) activities.push('HNDL');
  if (record.activity_stor) activities.push('STOR');
  if (record.activity_de_stor) activities.push('DE-STOR');
  
  return activities.length > 0 ? activities.join(', ') : 'Keine Aktivitäten';
}

function openHistoricalRecords() {
  if (currentComponent && currentComponent.barcode) {
    window.location.href = `/historical-record.html?barcode=${encodeURIComponent(currentComponent.barcode)}`;
  }
}

// Environmental History Functions
async function loadEnvironmentalHistory(barcode) {
  if (!barcode) return;
  
  try {
    console.log('🔍 Loading environmental history for barcode:', barcode);
    const response = await fetch(`/api/bauteil/${encodeURIComponent(barcode)}/environmental-history`);
    if (!response.ok) {
      console.warn('Environmental history API returned error:', response.status);
      displayEnvironmentalError();
      return;
    }
    
    const data = await response.json();
    console.log('📊 Environmental history data received:', data);
    displayEnvironmentalHistory(data);
    
  } catch (error) {
    console.error('Fehler beim Laden der Umgebungshistorie:', error);
    displayEnvironmentalError();
  }
}

function displayEnvironmentalHistory(data) {
  const tempTimeline = document.getElementById('temperature-timeline');
  const humidityTimeline = document.getElementById('humidity-timeline');
  
  if (!data.timeline || data.timeline.length === 0) {
    displayEnvironmentalError();
    return;
  }
  
  // Temperatur-Timeline
  if (tempTimeline) {
    tempTimeline.innerHTML = createTimeline(data.timeline, 'temperature', '°C');
  }
  
  // Feuchtigkeits-Timeline
  if (humidityTimeline) {
    humidityTimeline.innerHTML = createTimeline(data.timeline, 'humidity', '%');
  }
}

function createTimeline(timelineData, valueKey, unit) {
  // Filtere nur Datenpunkte mit Werten für den gewünschten Key
  const validData = timelineData.filter(point => point[valueKey] !== null && point[valueKey] !== undefined);
  
  if (validData.length === 0) {
    return '<div style="color: var(--gray-500);">Keine Daten verfügbar</div>';
  }
  
  // Aktuelle und letzte Werte
  const currentValue = validData[validData.length - 1][valueKey];
  const previousValue = validData.length > 1 ? validData[validData.length - 2][valueKey] : currentValue;
  const trend = currentValue > previousValue ? 'up' : currentValue < previousValue ? 'down' : 'stable';
  const trendIcon = trend === 'up' ? '↗' : trend === 'down' ? '↘' : '→';
  const trendColor = trend === 'up' ? '#4CAF50' : trend === 'down' ? '#FF6B6B' : '#666';
  
  return `
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <span style="font-weight: 600; color: ${valueKey === 'temperature' ? '#ff6b6b' : '#4ecdc4'};">${currentValue}${unit}</span>
      <span style="color: ${trendColor}; font-weight: 600;">${trendIcon}</span>
      <span style="color: var(--gray-500); font-size: 0.75rem;">${validData.length} Punkte</span>
    </div>
  `;
}

function displayEnvironmentalError() {
  const tempTimeline = document.getElementById('temperature-timeline');
  const humidityTimeline = document.getElementById('humidity-timeline');
  
  const errorHtml = '<div style="color: var(--gray-500);">Keine Daten verfügbar</div>';
  if (tempTimeline) tempTimeline.innerHTML = errorHtml;
  if (humidityTimeline) humidityTimeline.innerHTML = errorHtml;
}

// Global functions
window.removeImage = removeImage;
window.removeCurrentImage = removeCurrentImage;
window.storeComponentInCabinet = storeComponentInCabinet;
window.showStorageOptions = showStorageOptions;
window.removeFromStorage = removeFromStorage;
window.printComponentLabel = printComponentLabel;
window.copyComponentInfo = copyComponentInfo;
window.exportComponentData = exportComponentData;
window.openHistoricalRecords = openHistoricalRecords;

// Message display function
function showMessage(message, type = 'info') {
  console.log(`${type.toUpperCase()}: ${message}`);
  
  // Create toast element
  const toast = document.createElement('div');
  toast.className = `modern-toast ${type}`;
  toast.innerHTML = `
    <div style="display: flex; align-items: center; gap: 12px;">
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        ${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' :
          type === 'error' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>' :
          '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'}
      </svg>
      <span>${message}</span>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  // Remove after 4 seconds
  setTimeout(() => {
    toast.remove();
  }, 4000);
}
</script>

</body>
</html>