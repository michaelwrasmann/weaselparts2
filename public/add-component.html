<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WeaselParts - Neues Bauteil</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <header>
    <div class="header-content">
      <a href="/" class="logo">
        <svg class="logo-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
          <path fill="currentColor" d="M508.862,112.381c-4.797-3.806-47.682-37.184-75.929-37.184c-27.581,0-52.308,23.844-69.626,67.139c-10.743,26.856-24.697,26.856-38.192,26.856c-5.776,0-20.502-2.82-34.744-5.548c-20.389-3.905-43.49-8.33-57.625-8.275c-14.746,0.057-52.816,3.26-87.728,31.698c-31.702,25.822-51.001,65.459-56.011,114.89c-8.069,2.417-23.771,7.404-39.669,14.027C15.677,330.01,0,343.277,0,357.737c0,21.496,16.178,42.239,45.556,58.41c22.094,12.163,50.426,20.657,68.898,20.657c24.792,0,41.517-16.152,43.365-31.767c1.286-10.873-4.274-24.152-23.736-28.825c-19.624-4.71-34.346-10.988-44.13-16.064c11.112-2.083,23.886-2.809,31.072-2.94c4.073,2.64,14.61,9.738,24.149,16.231c1.376,0.938,3.002,1.439,4.668,1.439h70.773c3.118,0,5.973-1.748,7.389-4.526s1.156-6.115-0.677-8.639l-13.728-18.914c2.637-2.415,5.107-5.066,7.332-8.005c5.195-6.864,8.692-14.66,10.543-23.318c13.559-1.22,56.52-5.8,84.509-16.876c9.94,14.204,21.305,29.862,21.499,30.128c6.448,8.878,15.779,21.586,23.615,31.712c11.772,15.211,14.051,17.314,18.758,17.314h44.233c3.059,0,5.87-1.684,7.313-4.38c1.443-2.697,1.285-5.969-0.412-8.514l-14.236-21.355c-4.011-6.015-11.166-8.898-18.224-7.349l-2.914,0.64c-7.463-14.329-16.73-35.639-16.32-45.486c0.111-2.656,0.332-4.95,0.636-7.011c23.591-9.243,60.487-37.432,69.947-80.001c4.407-19.833,8.867-44.304,8.911-44.548c0.159-0.874,0.171-1.738,0.061-2.572c16.615-1.917,37.452-8.366,38.481-8.686c2.154-0.671,3.941-2.192,4.95-4.209l8.847-17.693C512.879,119.077,511.935,114.819,508.862,112.381z"/>
        </svg>
        <h1>WeaselParts</h1>
      </a>
      <nav class="top-nav">
        <div class="nav-left">
          <div class="lab-info">
            <span class="lab-name">Integrationslabor</span>
            <div class="mini-sensors">
              <span class="mini-sensor temp">
                <span id="temperature-value">--¬∞C</span>
              </span>
              <span class="mini-sensor humid">
                <span id="humidity-value">--%</span>
              </span>
            </div>
          </div>
          <div class="search-container">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input type="text" placeholder="Bauteile suchen" id="global-search">
          </div>
        </div>
        <div class="nav-icons">
          <button class="nav-btn" id="add-component-nav-btn" title="Neues Bauteil">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V18M18 12L6 12"></path>
            </svg>
          </button>
          <button class="nav-btn" id="manage-cabinets-nav-btn" title="Schr√§nke verwalten">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
            </svg>
          </button>
          <a href="/ICD.html" class="nav-btn" title="ICD">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </a>
        </div>
      </nav>
    </div>
  </header>

  <main class="main-content">
    <div class="page-header">
      <h1 class="page-title">Neues Bauteil anlegen</h1>
      <p class="page-subtitle">Erfasse ein neues elektronisches Bauteil in dein Inventar</p>
    </div>

    <div class="form-container">
      <form id="component-form" enctype="multipart/form-data">
        
        <!-- Barcode Section -->
        <div class="form-group">
          <label for="barcode">Barcode (automatisch generiert oder scannen)*:</label>
          <div class="barcode-input-group">
            <input type="text" id="barcode" name="barcode" required autocomplete="off" class="barcode-input">
            <div class="barcode-actions">
              <button type="button" id="scan-barcode-btn" class="btn secondary barcode-btn">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                </svg>
                Scannen
              </button>
              <button type="button" id="generate-barcode-btn" class="btn secondary barcode-btn">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Generieren
              </button>
            </div>
          </div>
        </div>

        <!-- Enhanced Image Upload Section with Camera Support -->
        <div class="form-group">
          <label>Bauteil-Foto:</label>
          <div class="image-upload-container">
            <!-- Tab Navigation -->
            <div class="image-upload-tabs">
              <button type="button" class="tab-button active" data-tab="upload">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                Datei hochladen
              </button>
              <button type="button" class="tab-button" data-tab="camera">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Foto aufnehmen
              </button>
            </div>

            <!-- Upload Tab Content -->
            <div id="upload-tab" class="tab-content active">
              <div class="image-upload-area" id="image-upload-area">
                <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <p>Bild hochladen</p>
                <span>Klicken oder Datei hierher ziehen</span>
              </div>
              <input type="file" id="component-image" name="image" accept="image/*" style="display: none;">
            </div>

            <!-- Camera Tab Content -->
            <div id="camera-tab" class="tab-content">
              <div class="camera-container">
                <div class="camera-preview">
                  <video id="camera-video" class="camera-video" autoplay muted playsinline></video>
                  <div class="camera-placeholder">
                    <svg width="80" height="80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <h4>Kamera bereit</h4>
                    <p>Klicke auf "Kamera starten" um ein Foto aufzunehmen</p>
                  </div>
                  <div class="camera-status">
                    <div class="camera-status-dot"></div>
                    Kamera gestoppt
                  </div>
                </div>
                <div class="camera-controls">
                  <button type="button" class="camera-btn start" data-action="start">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Kamera starten
                  </button>
                  <button type="button" class="camera-btn capture" data-action="capture" disabled>
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Foto aufnehmen
                  </button>
                  <button type="button" class="camera-btn stop" data-action="stop" disabled>
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10h6v4H9z"></path>
                    </svg>
                    Kamera stoppen
                  </button>
                  <button type="button" class="camera-btn switch" data-action="switch" disabled>
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                    </svg>
                    Kamera wechseln
                  </button>
                </div>
              </div>
            </div>

            <!-- Image Preview (shared) -->
            <div class="image-preview" id="image-preview"></div>
          </div>
        </div>

        <!-- Form Grid -->
        <div class="form-grid">
          <!-- Linke Spalte -->
          <div class="form-column">
            <div class="form-group">
              <label for="project">PROJECT*:</label>
              <input type="text" id="project" name="project" required class="highlight-field">
            </div>
            
            <div class="form-group">
              <label for="identification_number">IDENTIFICATION NUMBER:</label>
              <input type="text" id="identification_number" name="identification_number" class="highlight-field">
            </div>
          </div>
          
          <!-- Rechte Spalte -->
          <div class="form-column">
            <div class="form-group">
              <label for="responsible_engineer">RESPONSIBLE ENGINEER*:</label>
              <input type="text" id="responsible_engineer" name="responsible_engineer" required class="highlight-field">
            </div>
            
            <div class="form-group">
              <label for="equipment_name">EQUIPMENT NAME*:</label>
              <input type="text" id="equipment_name" name="equipment_name" required class="highlight-field">
            </div>
          </div>
        </div>

        <!-- Additional Fields -->
        <div class="form-group">
          <label for="name">Bauteil-Name:</label>
          <input type="text" id="name" name="name" placeholder="Wird automatisch aus Equipment Name √ºbernommen">
        </div>

        <div class="form-group">
          <label for="beschreibung">Beschreibung:</label>
          <textarea id="beschreibung" name="beschreibung" rows="3" placeholder="Optional: Zus√§tzliche Informationen zum Bauteil"></textarea>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn primary">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
            </svg>
            Speichern
          </button>
          <button type="reset" class="btn secondary">Zur√ºcksetzen</button>
          <button type="button" class="btn secondary" onclick="window.location.href='/'">Abbrechen</button>
        </div>
      </form>
    </div>
  </main>

  <!-- KRITISCH: Modals nur einmal definieren und initial versteckt -->
  <!-- Barcode Print Modal -->
  <div id="barcode-modal" class="modal" style="display: none; opacity: 0; visibility: hidden;">
    <div class="modal-content barcode-print-content">
      <div class="modal-header">
        <h3>Barcode erstellt!</h3>
        <button class="close-modal" id="close-barcode-modal">&times;</button>
      </div>
      
      <div class="barcode-display">
        <div class="barcode-info">
          <h4 id="barcode-component-name"></h4>
          <p><strong>Projekt:</strong> <span id="barcode-project"></span></p>
          <p><strong>Equipment:</strong> <span id="barcode-equipment"></span></p>
          <p><strong>Barcode:</strong> <span id="barcode-value"></span></p>
        </div>
        
        <div class="barcode-image-container">
          <img id="barcode-image" alt="Barcode" style="max-width: 100%; height: auto;">
        </div>
        
        <div class="barcode-actions">
          <button class="btn primary" id="print-barcode">
            üñ®Ô∏è Barcode drucken
          </button>
          <button class="btn secondary" id="download-barcode">
            üíæ Barcode herunterladen
          </button>
          <button class="btn secondary" id="close-modal-btn">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Schlie√üen
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scanner Modal -->
  <div id="scanner-modal" class="modal" style="display: none; opacity: 0; visibility: hidden;">
    <div class="modal-content scanner-content">
      <div class="scanner-header">
        <h2>Barcode scannen</h2>
        <button class="close-modal" id="close-scanner">&times;</button>
      </div>
      
      <div class="scanner-area">
        <div class="scanner-icon-container">
          <svg class="scanner-icon blinking" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
          </svg>
          <p>Barcode mit Scanner erfassen</p>
        </div>
        
        <div class="manual-input">
          <input type="text" id="scanner-input" placeholder="Oder Barcode hier eingeben..." autocomplete="off">
        </div>
      </div>
    </div>
  </div>

  <div id="toast-container"></div>

  <!-- SCRIPTS: Richtige Reihenfolge -->
  <script src="/js/api.js"></script>
  <script src="/js/common.js"></script>
  <script src="/js/camera.js"></script>
  <script src="/js/print-automation.js"></script>
  <script src="/js/fixes.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üìù Add Component wird initialisiert...');
      
      // KRITISCHER FIX: Alle Modals explizit schlie√üen
      forceCloseAllModals();

      try {
        setupEventListeners();
        checkForPrefillBarcode();
        
        // Barcode-Generierung
        setTimeout(() => {
          const barcodeInput = document.getElementById('barcode');
          if (barcodeInput && !barcodeInput.value) {
            generateBarcode();
          }
        }, 100);
        
        console.log('‚úÖ Add Component erfolgreich initialisiert');
      } catch (error) {
        console.error('‚ùå Initialisierungsfehler:', error);
        showMessage('Fehler beim Laden der Seite', 'error');
      }
    });

    function forceCloseAllModals() {
      console.log('üîß Zwinge alle Modals zum Schlie√üen...');
      
      const modalSelectors = [
        '#barcode-modal',
        '#scanner-modal',
        '.modal'
      ];
      
      modalSelectors.forEach(selector => {
        document.querySelectorAll(selector).forEach(modal => {
          modal.classList.remove('active');
          modal.style.display = 'none';
          modal.style.opacity = '0';
          modal.style.visibility = 'hidden';
        });
      });
      
      console.log('‚úÖ Alle Modals geschlossen');
    }

    function setupEventListeners() {
      console.log('üîß Event Listeners werden eingerichtet...');
      
      // Navigation Buttons
      const addBtn = document.getElementById('add-component-nav-btn');
      if (addBtn) {
        addBtn.addEventListener('click', () => {
          window.location.href = '/add-component.html';
        });
      }

      const manageCabinetsBtn = document.getElementById('manage-cabinets-nav-btn');
      if (manageCabinetsBtn) {
        manageCabinetsBtn.addEventListener('click', () => {
          window.location.href = '/manage-cabinets.html';
        });
      }
      
      // Global Search
      const globalSearch = document.getElementById('global-search');
      if (globalSearch) {
        globalSearch.addEventListener('input', handleGlobalSearch);
      }
      
      // Form Submission
      const form = document.getElementById('component-form');
      if (form) {
        form.addEventListener('submit', handleFormSubmit);
      }
      
      // Image Upload (File)
      const uploadArea = document.getElementById('image-upload-area');
      const fileInput = document.getElementById('component-image');
      
      if (uploadArea && fileInput) {
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);
      }
      
      // Tab-Wechsel f√ºr Kamera
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', (e) => {
          const tab = e.target.dataset.tab;
          switchTab(tab);
        });
      });
      
      // Auto-fill name from equipment
      const equipmentField = document.getElementById('equipment_name');
      if (equipmentField) {
        equipmentField.addEventListener('input', autoFillName);
      }
      
      // Scanner
      const scanBtn = document.getElementById('scan-barcode-btn');
      if (scanBtn) {
        scanBtn.addEventListener('click', openScanner);
      }
      
      const closeScanner = document.getElementById('close-scanner');
      if (closeScanner) {
        closeScanner.addEventListener('click', closeScannerModal);
      }
      
      const scannerInput = document.getElementById('scanner-input');
      if (scannerInput) {
        scannerInput.addEventListener('keypress', handleScannerInput);
      }
      
      // Barcode Generation
      const generateBtn = document.getElementById('generate-barcode-btn');
      if (generateBtn) {
        generateBtn.addEventListener('click', generateBarcode);
      }
      
      // Barcode Modal Events
      setupBarcodeModalEvents();
      
      console.log('‚úÖ Event Listeners eingerichtet');
    }

    function setupBarcodeModalEvents() {
      const closeBarcodeModal = document.getElementById('close-barcode-modal');
      if (closeBarcodeModal) {
        closeBarcodeModal.addEventListener('click', closeBarcodeModalHandler);
      }
      
      const closeModalBtn = document.getElementById('close-modal-btn');
      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeBarcodeModalHandler);
      }
      
      const printBarcode = document.getElementById('print-barcode');
      if (printBarcode) {
        printBarcode.addEventListener('click', printBarcodeHandler);
      }
      
      const downloadBarcode = document.getElementById('download-barcode');
      if (downloadBarcode) {
        downloadBarcode.addEventListener('click', downloadBarcodeHandler);
      }

      // Escape key to close modals
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeBarcodeModalHandler();
          closeScannerModal();
        }
      });

      // Click outside to close modals
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeBarcodeModalHandler();
            closeScannerModal();
          }
        });
      });
    }

    function switchTab(tabName) {
      console.log('üìë Wechsle zu Tab:', tabName);
      
      // Tab-Buttons aktualisieren
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tabName) {
          btn.classList.add('active');
        }
      });
      
      // Tab-Inhalte aktualisieren
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
        if (content.id === `${tabName}-tab`) {
          content.classList.add('active');
        }
      });
      
      // Bei Wechsel weg von Kamera ‚Üí Stream stoppen
      if (tabName !== 'camera' && window.weaselCamera && window.weaselCamera.isActive) {
        window.weaselCamera.stopCamera();
      }
    }

    function checkForPrefillBarcode() {
      const urlParams = new URLSearchParams(window.location.search);
      const barcode = urlParams.get('barcode');
      if (barcode) {
        const barcodeInput = document.getElementById('barcode');
        if (barcodeInput) {
          barcodeInput.value = barcode;
        }
      }
    }

    function generateBarcode() {
      try {
        const timestamp = Date.now();
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        const barcode = `WP${timestamp.toString().slice(-8)}${random}`;
        const barcodeInput = document.getElementById('barcode');
        if (barcodeInput) {
          barcodeInput.value = barcode;
        }
        console.log('üè∑Ô∏è Barcode generiert:', barcode);
        return barcode;
      } catch (error) {
        console.error('Fehler bei Barcode-Generierung:', error);
        showMessage('Fehler bei der Barcode-Generierung', 'error');
      }
    }

function autoFillName() {
      const equipmentName = document.getElementById('equipment_name');
      const nameField = document.getElementById('name');
      
      if (equipmentName && nameField) {
        if (!nameField.value || nameField.value === nameField.defaultValue) {
          nameField.value = equipmentName.value;
        }
      }
    }

    async function handleFormSubmit(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      
      // Basis-Daten sammeln
      const componentData = {
        barcode: formData.get('barcode'),
        name: formData.get('name') || formData.get('equipment_name'),
        beschreibung: formData.get('beschreibung'),
        project: formData.get('project'),
        responsible_engineer: formData.get('responsible_engineer'),
        equipment_name: formData.get('equipment_name'),
        identification_number: formData.get('identification_number')
      };

      // Validierung
      if (!componentData.barcode || !componentData.project || !componentData.responsible_engineer || !componentData.equipment_name) {
        showMessage('Bitte f√ºlle alle Pflichtfelder aus.', 'warning');
        return;
      }

      try {
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn ? submitBtn.innerHTML : '';
        
        if (submitBtn) {
          submitBtn.innerHTML = '<span class="spinner"></span> Speichert...';
          submitBtn.disabled = true;
        }
        
        // Bauteil erstellen
        const result = await api.createComponent(componentData);
        console.log('‚úÖ Bauteil erstellt:', result);
        
        // Bild hochladen, falls vorhanden
        const imageFile = formData.get('image');
        if (imageFile && imageFile.size > 0) {
          try {
            await api.uploadComponentImage(componentData.barcode, imageFile);
            console.log('‚úÖ Bild hochgeladen');
          } catch (imageError) {
            console.warn('Bild-Upload fehlgeschlagen:', imageError);
            showMessage('Bauteil erstellt, aber Bild-Upload fehlgeschlagen.', 'warning');
          }
        }
        
        // showMessage('Bauteil erfolgreich erstellt!', 'success'); // Entfernt auf Wunsch
        
        // Barcode-Druck-Modal anzeigen
        showBarcodeModal(componentData);
        
        if (submitBtn) {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
        
      } catch (error) {
        console.error('Fehler beim Erstellen:', error);
        showMessage(`Fehler beim Erstellen: ${error.message}`, 'error');
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }
    }

    // KRITISCHE FUNKTION: Sichere Modal-Steuerung
    function openModal(modalId) {
      console.log('üìñ √ñffne Modal:', modalId);
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
        setTimeout(() => {
          modal.style.opacity = '1';
          modal.style.visibility = 'visible';
        }, 10);
      }
    }

    function closeModal(modalId) {
      console.log('üìï Schlie√üe Modal:', modalId);
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('active');
        modal.style.opacity = '0';
        modal.style.visibility = 'hidden';
        setTimeout(() => {
          modal.style.display = 'none';
        }, 300);
      }
    }

    function showBarcodeModal(componentData) {
      console.log('üè∑Ô∏è Zeige Barcode Modal');
      
      // Modal-Felder f√ºllen
      const nameEl = document.getElementById('barcode-component-name');
      const projectEl = document.getElementById('barcode-project');
      const equipmentEl = document.getElementById('barcode-equipment');
      const valueEl = document.getElementById('barcode-value');
      const imageEl = document.getElementById('barcode-image');
      
      if (nameEl) nameEl.textContent = componentData.name;
      if (projectEl) projectEl.textContent = componentData.project;
      if (equipmentEl) equipmentEl.textContent = componentData.equipment_name;
      if (valueEl) valueEl.textContent = componentData.barcode;
      
      // Barcode-Bild von TEC-IT laden
      if (imageEl) {
        const barcodeImageUrl = `https://barcode.tec-it.com/barcode.ashx?data=${componentData.barcode}&code=Code128&translate-esc=on&unit=Fit&dpi=96&imagetype=Gif&rotation=0&color=%23000000&bgcolor=%23ffffff&qunit=Mm&quiet=0`;
        imageEl.src = barcodeImageUrl;
      }
      
      // Modal √∂ffnen
      openModal('barcode-modal');
    }

    function closeBarcodeModalHandler() {
      closeModal('barcode-modal');
      
      // Direkt zur Index-Seite weiterleiten
      setTimeout(() => {
        window.location.href = '/';
      }, 500);
    }

    function resetForm() {
      const form = document.getElementById('component-form');
      if (form) {
        form.reset();
      }
      
      const preview = document.getElementById('image-preview');
      if (preview) {
        preview.innerHTML = '';
      }
      
      generateBarcode();
      
      // Kamera stoppen falls aktiv
      if (window.weaselCamera && window.weaselCamera.isActive) {
        window.weaselCamera.stopCamera();
      }
    }

    // NEUE AUTOMATISCHE DRUCK-FUNKTION (wie in edit-component.html)
    function printBarcodeHandler() {
      const valueEl = document.getElementById('barcode-value');
      const nameEl = document.getElementById('barcode-component-name');
      
      if (!valueEl) return;
      
      const barcodeValue = valueEl.textContent;
      const componentName = nameEl ? nameEl.textContent : '';
      
      // Verwende die automatische Print-Funktion aus print-automation.js
      if (typeof autoPrintBarcode === 'function') {
        console.log('üñ®Ô∏è Verwende automatische Druckfunktion f√ºr 19x51mm Labels');
        autoPrintBarcode(barcodeValue, componentName, {
          labelSize: '19x51',
          dpi: 300,
          scale: 100
        });
      } else {
        console.warn('‚ö†Ô∏è Automatische Druckfunktion nicht verf√ºgbar, verwende Fallback');
        // Fallback zur alten Methode
        const printUrl = `https://barcode.tec-it.com/barcode.ashx?data=${barcodeValue}&code=Code128&translate-esc=on&unit=Fit&dpi=300&imagetype=Gif`;
        const printWindow = window.open(printUrl, '_blank');
        if (printWindow) {
          printWindow.onload = () => {
            printWindow.print();
          };
        }
      }
    }

    function downloadBarcodeHandler() {
      const valueEl = document.getElementById('barcode-value');
      if (!valueEl) return;
      
      const barcodeValue = valueEl.textContent;
      const downloadUrl = `https://barcode.tec-it.com/barcode.ashx?data=${barcodeValue}&code=Code128&translate-esc=on&unit=Fit&dpi=300&imagetype=Png`;
      
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = `barcode_${barcodeValue}.png`;
      link.click();
    }

    // Image Upload Functions (File Upload)
    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('drag-over');
    }

    function handleDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    }

    function handleFileSelect(e) {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    }

    function handleFile(file) {
      if (!file.type.startsWith('image/')) {
        showMessage('Bitte w√§hle eine Bilddatei aus.', 'warning');
        return;
      }
      
      if (file.size > 5 * 1024 * 1024) {
        showMessage('Datei ist zu gro√ü (Maximum: 5MB)', 'warning');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const preview = document.getElementById('image-preview');
        if (preview) {
          preview.innerHTML = `
            <div class="preview-container">
              <img src="${e.target.result}" alt="Vorschau" class="preview-image">
              <div class="preview-info">
                <span class="file-name">${file.name}</span>
                <button type="button" class="remove-image" onclick="removeImage()">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </div>
            </div>
          `;
        }
      };
      reader.readAsDataURL(file);
    }

    function removeImage() {
      const fileInput = document.getElementById('component-image');
      const preview = document.getElementById('image-preview');
      
      if (fileInput) fileInput.value = '';
      if (preview) preview.innerHTML = '';
    }

    // Scanner Functions
    function openScanner() {
      openModal('scanner-modal');
      
      const scannerInput = document.getElementById('scanner-input');
      if (scannerInput) {
        scannerInput.focus();
      }
      
      const scannerIcon = document.querySelector('.scanner-icon');
      if (scannerIcon) {
        scannerIcon.classList.add('blinking');
      }
    }

    function closeScannerModal() {
      closeModal('scanner-modal');
      
      const scannerInput = document.getElementById('scanner-input');
      if (scannerInput) {
        scannerInput.value = '';
      }
      
      const scannerIcon = document.querySelector('.scanner-icon');
      if (scannerIcon) {
        scannerIcon.classList.remove('blinking');
      }
    }

    function handleScannerInput(e) {
      if (e.key === 'Enter') {
        const scannedValue = e.target.value.trim();
        if (scannedValue) {
          const barcodeInput = document.getElementById('barcode');
          if (barcodeInput) {
            barcodeInput.value = scannedValue;
          }
          closeScannerModal();
          showMessage('Barcode erfolgreich gescannt!', 'success');
        }
      }
    }

    function handleGlobalSearch() {
      const searchInput = document.getElementById('global-search');
      if (!searchInput) return;
      
      const query = searchInput.value.toLowerCase().trim();
      
      if (query) {
        // Redirect to index with search query
        window.location.href = `/?search=${encodeURIComponent(query)}`;
      }
    }

    // Globale Funktionen verf√ºgbar machen
    window.removeImage = removeImage;

    // Sensordaten-Funktionen
    function updateSensorData() {
      // Simulierte Sensordaten - in der Praxis w√ºrden diese von einem API-Endpoint kommen
      const temperature = (Math.random() * 5 + 22).toFixed(1); // 22-27¬∞C
      const humidity = (Math.random() * 10 + 45).toFixed(0); // 45-55%
      
      const tempElement = document.getElementById('temperature-value');
      const humidElement = document.getElementById('humidity-value');
      
      if (tempElement) tempElement.textContent = `${temperature}¬∞C`;
      if (humidElement) humidElement.textContent = `${humidity}%`;
    }

    // Sensordaten alle 30 Sekunden aktualisieren
    setInterval(updateSensorData, 30000);
    // Initial einmal laden
    updateSensorData();

    // Error Handling
    window.addEventListener('error', function(e) {
      console.error('‚ùå Globaler Fehler:', e);
      if (e.message && e.message.includes('null')) {
        showMessage('Ein Element konnte nicht gefunden werden. Bitte lade die Seite neu.', 'warning');
      }
    });
  </script>
  
  <style>
    /* Barcode Input Group Styling */
    .barcode-input-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .barcode-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--primary-green);
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      background: var(--bg-card);
      color: var(--text-primary);
      transition: var(--smooth-transition);
    }

    .barcode-input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(196, 214, 0, 0.2);
    }

    .barcode-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .barcode-btn {
      flex: 1;
      max-width: 150px;
      padding: 10px 16px !important;
      font-size: 14px !important;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: var(--smooth-transition);
    }

    .barcode-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .barcode-btn svg {
      flex-shrink: 0;
    }

    /* KRITISCH: Modal-Fixes */
    .modal {
      display: none !important;
      opacity: 0 !important;
      visibility: hidden !important;
    }

    .modal.active {
      display: flex !important;
      opacity: 1 !important;
      visibility: visible !important;
    }

    /* Spinner Animation */
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      display: inline-block;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Scanner Modal Styles */
    .scanner-area {
      padding: 40px 20px;
      text-align: center;
      min-height: 300px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 30px;
    }

    .scanner-icon-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .scanner-icon {
      width: 80px;
      height: 80px;
      stroke: var(--primary-blue);
      opacity: 0.7;
    }

    .scanner-icon.blinking {
      animation: blink 1.5s infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 0.7; }
      51%, 100% { opacity: 0.3; }
    }

    .scanner-icon-container p {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .manual-input {
      width: 100%;
      max-width: 300px;
    }

    .manual-input input {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid var(--primary-blue);
      border-radius: 12px;
      font-size: 16px;
      text-align: center;
      background: var(--bg-card);
      color: var(--text-primary);
      transition: var(--smooth-transition);
    }

    .manual-input input:focus {
      outline: none;
      border-color: var(--primary-green);
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
    }

    /* Barcode Modal Styles */
    .barcode-print-content {
      max-width: 600px;
      width: 90%;
    }

    .barcode-display {
      padding: 30px;
    }

    .barcode-info {
      text-align: center;
      margin-bottom: 30px;
    }

    .barcode-info h4 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    .barcode-info p {
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .barcode-image-container {
      text-align: center;
      margin: 30px 0;
      padding: 20px;
      background: white;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .barcode-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 30px;
    }

    .barcode-actions .btn {
      flex: 1;
      max-width: 200px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
    }

    /* Navigation Lab Info Styles */
    .nav-left {
      display: flex;
      align-items: center;
      gap: 24px;
      flex: 1;
    }

    .lab-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .lab-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .mini-sensors {
      display: flex;
      gap: 12px;
    }

    .mini-sensor {
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
    }

    .mini-sensor.temp {
      color: #FF6B35;
    }

    .mini-sensor.humid {
      color: #4A90E2;
    }

    /* Responsive Design f√ºr Barcode Section */
    @media (max-width: 480px) {
      .barcode-actions {
        flex-direction: column;
      }
      
      .barcode-btn {
        max-width: none;
      }

      .barcode-actions .btn {
        max-width: none;
      }

      .nav-left {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .lab-info {
        align-self: stretch;
      }

      .mini-sensors {
        justify-content: space-between;
      }
    }
  </style>
</body>
</html>
