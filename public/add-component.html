<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WeaselParts - Neues Bauteil</title>
  <link rel="stylesheet" href="/css/modern-styles.css">
  <!-- Page Transitions -->
  <script src="/js/page-transitions.js"></script>
  <!-- Modal Animations -->
  <script src="/js/modal-animations.js"></script>
</head>
<body class="page-add-component">
<div class="modern-container">
  <!-- Modern Header -->
  <header class="modern-header">
    <nav class="modern-nav">
      <a href="/" class="modern-logo">
        <img src="/images/weasel-svgrepo-com.svg" alt="WeaselParts">
        <span>WeaselParts</span>
      </a>
      
      <!-- Search Bar -->
      <div class="modern-search">
        <input type="text" placeholder="Bauteile suchen..." id="global-search">
      </div>
      
      <!-- Sensor Data Display -->
      <div class="modern-sensors">
        <div class="modern-sensor temp" id="temperature-value">--°C</div>
        <div class="modern-sensor humid" id="humidity-value">--%</div>
        <select id="sensor-location-select" class="modern-select" style="font-size: 0.875rem; padding: 0.25rem 0.5rem;">
          <option value="ssa">Jarvis-Ecke</option>
          <option value="int_up">Am Telefon</option>
          <option value="emp">Empore</option>
        </select>
      </div>
      
      <!-- Navigation Buttons -->
      <div class="modern-nav-buttons">
        <button class="modern-nav-btn" id="add-component-nav-btn" title="Neues Bauteil">
          <img src="/images/button_add_component.png" alt="Neues Bauteil">
        </button>
        <button class="modern-nav-btn" id="manage-cabinets-nav-btn" title="Schränke verwalten">
          <img src="/images/button_manage_cabinet.png" alt="Schränke">
        </button>
        <a href="/ICD.html" class="modern-nav-btn" title="ICD">
          <img src="/images/button_icd.png" alt="ICD">
        </a>
        <a href="/lab-overview.html" class="modern-nav-btn" title="Labor-Übersicht">
          <img src="/images/button_lab_overview.png" alt="Labor">
        </a>
        <a href="/glue-protocol.html" class="modern-nav-btn" title="Klebeprotokoll">
          <img src="/images/button_glue_protocol.png" alt="Kleben">
        </a>
        <a href="/settings.html" class="modern-nav-btn" title="Einstellungen">
          <img src="/images/button_settings.png" alt="Settings">
        </a>
      </div>
    </nav>
  </header>

  <!-- Split Screen Layout -->
  <div class="modern-wrapper">
    <!-- Content Panel - Left Side -->
    <div class="content-panel">
      <div class="modern-content">
        
        <!-- Page Header -->
        <div class="modern-page-header">
          <h1 class="modern-title">Neues Bauteil</h1>
        </div>

        <div class="modern-panel">
      <form id="component-form" enctype="multipart/form-data">
        
        <!-- Barcode Section -->
        <div class="modern-form-group">
          <label for="barcode" class="modern-label">Barcode (automatisch generiert)*:</label>
          <div class="barcode-input-row">
            <input type="text" id="barcode" name="barcode" required autocomplete="off" class="modern-input barcode-input-half">
            <button type="button" id="generate-barcode-btn" class="modern-btn modern-btn-secondary">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Neu generieren
            </button>
          </div>
        </div>

        <!-- Image Upload with Camera -->
        <div class="modern-form-group" style="margin-bottom: 40px;">
          <label class="modern-label">Bauteil-Foto (optional):</label>
          <div class="photo-options">
            <button type="button" class="modern-btn modern-btn-secondary" onclick="document.getElementById('component-image').click()">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 13v4a2 2 0 01-2 2H8a2 2 0 01-2-2V7a2 2 0 012-2h4l4 4v4z"></path>
              </svg>
              Datei wählen
            </button>
            <button type="button" class="modern-btn modern-btn-secondary" onclick="toggleCamera()" id="camera-toggle-btn">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
              Kamera starten
            </button>
            <input type="file" id="component-image" name="image" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
          </div>
          
          <!-- Inline Camera Section -->
          <div id="camera-section" class="camera-section" style="display: none;">
            <div class="inline-camera-container">
              <video id="camera-video" width="320" height="240" autoplay playsinline></video>
              <canvas id="camera-canvas" width="320" height="240" style="display: none;"></canvas>
            </div>
            <div class="inline-camera-controls">
              <button type="button" class="modern-btn modern-btn-primary" onclick="capturePhoto()">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                  <circle cx="12" cy="13" r="3"></circle>
                </svg>
                Foto aufnehmen
              </button>
              <button type="button" class="modern-btn modern-btn-secondary" onclick="stopCamera()">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                Kamera stoppen
              </button>
            </div>
          </div>
          
          <div class="image-preview" id="image-preview"></div>
        </div>

        <!-- Compact Form Fields -->
        <div class="modern-form-group">
          <label for="project" class="modern-label">Projekt*:</label>
          <select id="project" name="project" required class="modern-select">
            <option value="">Projekt auswählen...</option>
          </select>
        </div>
        
        <div class="modern-form-group">
          <label for="responsible_engineer" class="modern-label">Verantwortlicher*:</label>
          <select id="responsible_engineer" name="responsible_engineer" required class="modern-select">
            <option value="">Mitarbeiter auswählen...</option>
          </select>
        </div>
        
        <div class="modern-form-group">
          <label for="equipment_name" class="modern-label">Equipment Name*:</label>
          <input type="text" id="equipment_name" name="equipment_name" required class="modern-input">
        </div>

        <div class="modern-form-group">
          <label for="identification_number" class="modern-label">ID-Nummer:</label>
          <input type="text" id="identification_number" name="identification_number" class="modern-input">
        </div>

        <div class="modern-form-group">
          <label for="beschreibung" class="modern-label">Beschreibung:</label>
          <textarea id="beschreibung" name="beschreibung" rows="2" placeholder="Optional" class="modern-textarea"></textarea>
        </div>

        <div class="form-actions">
          <button type="submit" class="modern-btn modern-btn-primary">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
            </svg>
            Speichern
          </button>
          <button type="reset" class="modern-btn modern-btn-secondary">Zurücksetzen</button>
          <button type="button" class="modern-btn modern-btn-secondary" onclick="window.location.href='/'">Abbrechen</button>
        </div>
        </form>
      </div>
      </div>
    </div>
    
    <!-- Background Panel - Right Side -->
    <div class="background-panel">
      <img src="/images/background_icon_add_component.png" alt="Background Icon" class="background-icon">
    </div>
  </div>
</div>

<!-- Modals -->
<div id="barcode-modal" class="modern-modal" style="display: none;">
  <div class="modern-modal-content">
    <div class="modal-titlebar">
      <h3>Barcode erstellt!</h3>
      <button class="modal-close-btn" id="close-barcode-modal">&times;</button>
    </div>
    <div class="modern-modal-body">
      <div class="barcode-info">
        <h4 id="barcode-component-name"></h4>
        <p><strong>Projekt:</strong> <span id="barcode-project"></span></p>
        <p><strong>Equipment:</strong> <span id="barcode-equipment"></span></p>
        <p><strong>Barcode:</strong> <span id="barcode-value"></span></p>
      </div>
      <div class="barcode-image-container">
        <img id="barcode-image" alt="Barcode" style="max-width: 100%; height: auto;">
      </div>
      <div class="modern-modal-footer">
        <button class="modern-btn modern-btn-primary" id="print-barcode">🖨️ Drucken</button>
        <button class="modern-btn modern-btn-secondary" id="download-barcode">💾 Download</button>
        <button class="modern-btn modern-btn-secondary" id="close-modal-btn">Schließen</button>
      </div>
    </div>
  </div>
</div>

<div id="scanner-modal" class="modern-modal" style="display: none;">
  <div class="modern-modal-content">
    <div class="modal-titlebar">
      <h3>Barcode scannen</h3>
      <button class="modal-close-btn" id="close-scanner">&times;</button>
    </div>
    <div class="modern-modal-body">
      <div class="scanner-area">
        <svg class="scanner-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
        </svg>
        <p>Barcode mit Scanner erfassen</p>
        <input type="text" id="scanner-input" placeholder="Oder Barcode hier eingeben..." autocomplete="off" class="modern-input">
      </div>
    </div>
  </div>
</div>

<div id="toast-container"></div>

  <!-- SCRIPTS: Richtige Reihenfolge -->
  <script src="/js/api.js"></script>
  <script src="/js/common.js"></script>
  <script src="/js/camera.js"></script>
  <script src="/js/print-automation.js"></script>
  <script src="/js/fixes.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('📝 Add Component wird initialisiert...');
      
      // KRITISCHER FIX: Alle Modals explizit schließen
      forceCloseAllModals();

      try {
        setupEventListeners();
        checkForPrefillBarcode();
        await loadSensorData();
        startSensorRefresh();
        
        // Barcode-Generierung
        setTimeout(() => {
          const barcodeInput = document.getElementById('barcode');
          if (barcodeInput && !barcodeInput.value) {
            generateBarcode();
          }
        }, 100);
        
        console.log('✅ Add Component erfolgreich initialisiert');
      } catch (error) {
        console.error('❌ Initialisierungsfehler:', error);
        showMessage('Fehler beim Laden der Seite', 'error');
      }
    });

    function forceCloseAllModals() {
      console.log('🔧 Zwinge alle Modals zum Schließen...');
      
      const modalSelectors = [
        '#barcode-modal',
        '#scanner-modal',
        '.modal'
      ];
      
      modalSelectors.forEach(selector => {
        document.querySelectorAll(selector).forEach(modal => {
          modal.classList.remove('active');
          modal.style.display = 'none';
          modal.style.opacity = '0';
          modal.style.visibility = 'hidden';
        });
      });
      
      console.log('✅ Alle Modals geschlossen');
    }

    function setupEventListeners() {
      console.log('🔧 Event Listeners werden eingerichtet...');
      
      // Navigation Buttons - Let page-transitions.js handle these
      
      // Global Search
      const globalSearch = document.getElementById('global-search');
      if (globalSearch) {
        globalSearch.addEventListener('input', handleGlobalSearch);
      }
      
      // Sensor Location Dropdown
      const locationSelect = document.getElementById('sensor-location-select');
      if (locationSelect) {
        locationSelect.addEventListener('change', async () => {
          await loadSensorData();
        });
      }
      
      // Form Submission
      const form = document.getElementById('component-form');
      if (form) {
        form.addEventListener('submit', handleFormSubmit);
      }
      
      // Image Upload (File)
      const uploadArea = document.getElementById('image-upload-area');
      const fileInput = document.getElementById('component-image');
      
      if (uploadArea && fileInput) {
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);
      }
      
      // Tab-Wechsel für Kamera
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', (e) => {
          const tab = e.target.dataset.tab;
          switchTab(tab);
        });
      });
      
      // Auto-fill name from equipment
      const equipmentField = document.getElementById('equipment_name');
      if (equipmentField) {
        equipmentField.addEventListener('input', autoFillName);
      }
      
      // Scanner
      const scanBtn = document.getElementById('scan-barcode-btn');
      if (scanBtn) {
        scanBtn.addEventListener('click', openScanner);
      }
      
      const closeScanner = document.getElementById('close-scanner');
      if (closeScanner) {
        closeScanner.addEventListener('click', closeScannerModal);
      }
      
      const scannerInput = document.getElementById('scanner-input');
      if (scannerInput) {
        scannerInput.addEventListener('keypress', handleScannerInput);
      }
      
      // Barcode Generation
      const generateBtn = document.getElementById('generate-barcode-btn');
      if (generateBtn) {
        generateBtn.addEventListener('click', generateBarcode);
      }
      
      // Barcode Modal Events
      setupBarcodeModalEvents();
      
      console.log('✅ Event Listeners eingerichtet');
    }

    function setupBarcodeModalEvents() {
      const closeBarcodeModal = document.getElementById('close-barcode-modal');
      if (closeBarcodeModal) {
        closeBarcodeModal.addEventListener('click', closeBarcodeModalHandler);
      }
      
      const closeModalBtn = document.getElementById('close-modal-btn');
      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeBarcodeModalHandler);
      }
      
      const printBarcode = document.getElementById('print-barcode');
      if (printBarcode) {
        printBarcode.addEventListener('click', printBarcodeHandler);
      }
      
      const downloadBarcode = document.getElementById('download-barcode');
      if (downloadBarcode) {
        downloadBarcode.addEventListener('click', downloadBarcodeHandler);
      }

      // Escape key to close modals
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeBarcodeModalHandler();
          closeScannerModal();
        }
      });

      // Click outside to close modals
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeBarcodeModalHandler();
            closeScannerModal();
          }
        });
      });
    }

    function switchTab(tabName) {
      console.log('📑 Wechsle zu Tab:', tabName);
      
      // Tab-Buttons aktualisieren
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tabName) {
          btn.classList.add('active');
        }
      });
      
      // Tab-Inhalte aktualisieren
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
        if (content.id === `${tabName}-tab`) {
          content.classList.add('active');
        }
      });
      
      // Bei Wechsel weg von Kamera → Stream stoppen
      if (tabName !== 'camera' && window.weaselCamera && window.weaselCamera.isActive) {
        window.weaselCamera.stopCamera();
      }
    }

    function checkForPrefillBarcode() {
      const urlParams = new URLSearchParams(window.location.search);
      const barcode = urlParams.get('barcode');
      if (barcode) {
        const barcodeInput = document.getElementById('barcode');
        if (barcodeInput) {
          barcodeInput.value = barcode;
        }
      }
    }

    function generateBarcode() {
      try {
        const timestamp = Date.now();
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        const barcode = `WP${timestamp.toString().slice(-8)}${random}`;
        const barcodeInput = document.getElementById('barcode');
        if (barcodeInput) {
          barcodeInput.value = barcode;
        }
        console.log('🏷️ Barcode generiert:', barcode);
        return barcode;
      } catch (error) {
        console.error('Fehler bei Barcode-Generierung:', error);
        showMessage('Fehler bei der Barcode-Generierung', 'error');
      }
    }

function autoFillName() {
      const equipmentName = document.getElementById('equipment_name');
      const nameField = document.getElementById('name');
      
      if (equipmentName && nameField) {
        if (!nameField.value || nameField.value === nameField.defaultValue) {
          nameField.value = equipmentName.value;
        }
      }
    }

    async function handleFormSubmit(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      
      // Basis-Daten sammeln
      const componentData = {
        barcode: formData.get('barcode'),
        name: formData.get('name') || formData.get('equipment_name'),
        beschreibung: formData.get('beschreibung'),
        project: formData.get('project'),
        responsible_engineer: formData.get('responsible_engineer'),
        equipment_name: formData.get('equipment_name'),
        identification_number: formData.get('identification_number')
      };

      // Validierung
      if (!componentData.barcode || !componentData.project || !componentData.responsible_engineer || !componentData.equipment_name) {
        showMessage('Bitte fülle alle Pflichtfelder aus.', 'warning');
        return;
      }

      try {
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn ? submitBtn.innerHTML : '';
        
        if (submitBtn) {
          submitBtn.innerHTML = '<span class="spinner"></span> Speichert...';
          submitBtn.disabled = true;
        }
        
        // Bauteil erstellen
        const result = await api.createComponent(componentData);
        console.log('✅ Bauteil erstellt:', result);
        
        // Bild hochladen, falls vorhanden
        const imageFile = formData.get('image');
        if (imageFile && imageFile.size > 0) {
          try {
            await api.uploadComponentImage(componentData.barcode, imageFile);
            console.log('✅ Bild hochgeladen');
          } catch (imageError) {
            console.warn('Bild-Upload fehlgeschlagen:', imageError);
            showMessage('Bauteil erstellt, aber Bild-Upload fehlgeschlagen.', 'warning');
          }
        }
        
        // showMessage('Bauteil erfolgreich erstellt!', 'success'); // Entfernt auf Wunsch
        
        // Barcode-Druck-Modal anzeigen
        showBarcodeModal(componentData);
        
        if (submitBtn) {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
        
      } catch (error) {
        console.error('Fehler beim Erstellen:', error);
        showMessage(`Fehler beim Erstellen: ${error.message}`, 'error');
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }
    }

    // KRITISCHE FUNKTION: Sichere Modal-Steuerung
    function openModal(modalId) {
      console.log('📖 Öffne Modal:', modalId);
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
        setTimeout(() => {
          modal.style.opacity = '1';
          modal.style.visibility = 'visible';
        }, 10);
      }
    }

    function closeModal(modalId) {
      console.log('📕 Schließe Modal:', modalId);
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('active');
        modal.style.opacity = '0';
        modal.style.visibility = 'hidden';
        setTimeout(() => {
          modal.style.display = 'none';
        }, 300);
      }
    }

    function showBarcodeModal(componentData) {
      console.log('🏷️ Zeige Barcode Modal');
      
      // Modal-Felder füllen
      const nameEl = document.getElementById('barcode-component-name');
      const projectEl = document.getElementById('barcode-project');
      const equipmentEl = document.getElementById('barcode-equipment');
      const valueEl = document.getElementById('barcode-value');
      const imageEl = document.getElementById('barcode-image');
      
      if (nameEl) nameEl.textContent = componentData.name;
      if (projectEl) projectEl.textContent = componentData.project;
      if (equipmentEl) equipmentEl.textContent = componentData.equipment_name;
      if (valueEl) valueEl.textContent = componentData.barcode;
      
      // Barcode-Bild von TEC-IT laden
      if (imageEl) {
        const barcodeImageUrl = `https://barcode.tec-it.com/barcode.ashx?data=${componentData.barcode}&code=Code128&translate-esc=on&unit=Fit&dpi=96&imagetype=Gif&rotation=0&color=%23000000&bgcolor=%23ffffff&qunit=Mm&quiet=0`;
        imageEl.src = barcodeImageUrl;
      }
      
      // Modal öffnen
      openModal('barcode-modal');
    }

    function closeBarcodeModalHandler() {
      closeModal('barcode-modal');
      
      // Direkt zur Index-Seite weiterleiten
      setTimeout(() => {
        window.location.href = '/';
      }, 500);
    }

    function resetForm() {
      const form = document.getElementById('component-form');
      if (form) {
        form.reset();
      }
      
      const preview = document.getElementById('image-preview');
      if (preview) {
        preview.innerHTML = '';
      }
      
      generateBarcode();
      
      // Kamera stoppen falls aktiv
      if (window.weaselCamera && window.weaselCamera.isActive) {
        window.weaselCamera.stopCamera();
      }
    }

    // NEUE AUTOMATISCHE DRUCK-FUNKTION (wie in edit-component.html)
    function printBarcodeHandler() {
      const valueEl = document.getElementById('barcode-value');
      const nameEl = document.getElementById('barcode-component-name');
      
      if (!valueEl) return;
      
      const barcodeValue = valueEl.textContent;
      const componentName = nameEl ? nameEl.textContent : '';
      
      // Verwende die automatische Print-Funktion aus print-automation.js
      if (typeof autoPrintBarcode === 'function') {
        console.log('🖨️ Verwende automatische Druckfunktion für 19x51mm Labels');
        autoPrintBarcode(barcodeValue, componentName, {
          labelSize: '19x51',
          dpi: 300,
          scale: 100
        });
      } else {
        console.warn('⚠️ Automatische Druckfunktion nicht verfügbar, verwende Fallback');
        // Fallback zur alten Methode
        const printUrl = `https://barcode.tec-it.com/barcode.ashx?data=${barcodeValue}&code=Code128&translate-esc=on&unit=Fit&dpi=300&imagetype=Gif`;
        const printWindow = window.open(printUrl, '_blank');
        if (printWindow) {
          printWindow.onload = () => {
            printWindow.print();
          };
        }
      }
    }

    function downloadBarcodeHandler() {
      const valueEl = document.getElementById('barcode-value');
      if (!valueEl) return;
      
      const barcodeValue = valueEl.textContent;
      const downloadUrl = `https://barcode.tec-it.com/barcode.ashx?data=${barcodeValue}&code=Code128&translate-esc=on&unit=Fit&dpi=300&imagetype=Png`;
      
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = `barcode_${barcodeValue}.png`;
      link.click();
    }

    // Image Upload Functions (File Upload)
    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('drag-over');
    }

    function handleDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    }

    function handleFileSelect(e) {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    }
    
    // Simplified version for inline use
    window.handleFileSelect = function(e) {
      if (e.target.files.length > 0) {
        const file = e.target.files[0];
        if (!file.type.startsWith('image/')) {
          showMessage('Bitte wähle eine Bilddatei aus.', 'warning');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          const preview = document.getElementById('image-preview');
          if (preview) {
            preview.innerHTML = `<img src="${e.target.result}" alt="Vorschau" style="max-width: 200px; max-height: 150px; border-radius: 8px;">`;
          }
        };
        reader.readAsDataURL(file);
      }
    };

    function handleFile(file) {
      if (!file.type.startsWith('image/')) {
        showMessage('Bitte wähle eine Bilddatei aus.', 'warning');
        return;
      }
      
      if (file.size > 5 * 1024 * 1024) {
        showMessage('Datei ist zu groß (Maximum: 5MB)', 'warning');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const preview = document.getElementById('image-preview');
        if (preview) {
          preview.innerHTML = `
            <div class="preview-container">
              <img src="${e.target.result}" alt="Vorschau" class="preview-image">
              <div class="preview-info">
                <span class="file-name">${file.name}</span>
                <button type="button" class="remove-image" onclick="removeImage()">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </div>
            </div>
          `;
        }
      };
      reader.readAsDataURL(file);
    }

    function removeImage() {
      const fileInput = document.getElementById('component-image');
      const preview = document.getElementById('image-preview');
      
      if (fileInput) fileInput.value = '';
      if (preview) preview.innerHTML = '';
    }

    // Scanner Functions
    function openScanner() {
      openModal('scanner-modal');
      
      const scannerInput = document.getElementById('scanner-input');
      if (scannerInput) {
        scannerInput.focus();
      }
      
      const scannerIcon = document.querySelector('.scanner-icon');
      if (scannerIcon) {
        scannerIcon.classList.add('blinking');
      }
    }

    function closeScannerModal() {
      closeModal('scanner-modal');
      
      const scannerInput = document.getElementById('scanner-input');
      if (scannerInput) {
        scannerInput.value = '';
      }
      
      const scannerIcon = document.querySelector('.scanner-icon');
      if (scannerIcon) {
        scannerIcon.classList.remove('blinking');
      }
    }

    function handleScannerInput(e) {
      if (e.key === 'Enter') {
        const scannedValue = e.target.value.trim();
        if (scannedValue) {
          const barcodeInput = document.getElementById('barcode');
          if (barcodeInput) {
            barcodeInput.value = scannedValue;
          }
          closeScannerModal();
          showMessage('Barcode erfolgreich gescannt!', 'success');
        }
      }
    }

    function handleGlobalSearch() {
      const searchInput = document.getElementById('global-search');
      if (!searchInput) return;
      
      const query = searchInput.value.toLowerCase().trim();
      
      if (query) {
        // Redirect to index with search query
        window.location.href = `/?search=${encodeURIComponent(query)}`;
      }
    }

    // Globale Funktionen verfügbar machen
    window.removeImage = removeImage;
    
    // Camera Functions
    let cameraStream = null;
    let cameraActive = false;
    
    window.toggleCamera = async function() {
      if (!cameraActive) {
        await startCamera();
      } else {
        stopCamera();
      }
    };
    
    async function startCamera() {
      try {
        const cameraSection = document.getElementById('camera-section');
        const video = document.getElementById('camera-video');
        const toggleBtn = document.getElementById('camera-toggle-btn');
        
        // Request camera access
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment', // Try back camera first
            width: 320,
            height: 240
          } 
        });
        
        video.srcObject = cameraStream;
        cameraSection.style.display = 'block';
        toggleBtn.textContent = '📷 Kamera läuft';
        toggleBtn.classList.add('active');
        cameraActive = true;
        
        showMessage('Kamera gestartet!', 'success');
      } catch (error) {
        console.error('Kamera-Zugriff fehlgeschlagen:', error);
        showMessage('Kamera-Zugriff fehlgeschlagen. Bitte Berechtigung erteilen.', 'error');
      }
    }
    
    window.stopCamera = function() {
      const cameraSection = document.getElementById('camera-section');
      const video = document.getElementById('camera-video');
      const toggleBtn = document.getElementById('camera-toggle-btn');
      
      // Stop camera stream
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
      
      video.srcObject = null;
      cameraSection.style.display = 'none';
      toggleBtn.textContent = '📷 Kamera starten';
      toggleBtn.classList.remove('active');
      cameraActive = false;
      
      showMessage('Kamera gestoppt', 'info');
    };
    
    window.capturePhoto = function() {
      const video = document.getElementById('camera-video');
      const canvas = document.getElementById('camera-canvas');
      const ctx = canvas.getContext('2d');
      
      // Draw video frame to canvas
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // Convert to blob and create file
      canvas.toBlob((blob) => {
        const file = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });
        
        // Update file input
        const fileInput = document.getElementById('component-image');
        const dt = new DataTransfer();
        dt.items.add(file);
        fileInput.files = dt.files;
        
        // Show preview
        const preview = document.getElementById('image-preview');
        const imgUrl = canvas.toDataURL();
        preview.innerHTML = `<img src="${imgUrl}" alt="Kamera-Foto" style="max-width: 200px; max-height: 150px; border-radius: 8px;">`;
        
        // Close camera
        closeCamera();
        showMessage('Foto erfolgreich aufgenommen!', 'success');
      }, 'image/jpeg', 0.8);
    };

    // Sensordaten-Funktionen
    function updateSensorData() {
      // Simulierte Sensordaten - in der Praxis würden diese von einem API-Endpoint kommen
      const temperature = (Math.random() * 5 + 22).toFixed(1); // 22-27°C
      const humidity = (Math.random() * 10 + 45).toFixed(0); // 45-55%
      
      const tempElement = document.getElementById('temperature-value');
      const humidElement = document.getElementById('humidity-value');
      
      if (tempElement) tempElement.textContent = `${temperature}°C`;
      if (humidElement) humidElement.textContent = `${humidity}%`;
    }

    // Sensordaten alle 30 Sekunden aktualisieren
    setInterval(updateSensorData, 30000);
    // Initial einmal laden
    updateSensorData();

    // Error Handling
    window.addEventListener('error', function(e) {
      console.error('❌ Globaler Fehler:', e);
      if (e.message && e.message.includes('null')) {
        showMessage('Ein Element konnte nicht gefunden werden. Bitte lade die Seite neu.', 'warning');
      }
    });

    // Sensor Data Functions
    async function loadSensorData() {
      try {
        const locationSelect = document.getElementById('sensor-location-select');
        const location = locationSelect ? locationSelect.value : 'ssa';
        
        const response = await fetch(`/api/sensors/current/${location}`);
        if (!response.ok) return;
        
        const sensorData = await response.json();
        updateSensorDisplay(sensorData);
      } catch (error) {
        console.error('❌ Sensordaten Fehler:', error);
      }
    }
    
    function updateSensorDisplay(data) {
      try {
        // Temperature
        const tempValue = document.getElementById('temperature-value');
        if (tempValue) {
          if (data.temperature && data.temperature.temperature !== null && !isNaN(data.temperature.temperature)) {
            tempValue.textContent = `${data.temperature.temperature.toFixed(1)}°C`;
          } else {
            tempValue.textContent = '--°C';
          }
        }
        
        // Humidity
        const humValue = document.getElementById('humidity-value');
        if (humValue) {
          if (data.humidity && data.humidity.humidity !== null && !isNaN(data.humidity.humidity)) {
            humValue.textContent = `${data.humidity.humidity.toFixed(1)}%`;
          } else {
            humValue.textContent = '--%';
          }
        }
        
        // Debug-Info bei Fehler
        if (data.error || data.warning) {
          console.warn('⚠️ Sensordaten-Warnung:', data.errorMessage || data.warning);
        }
      } catch (error) {
        console.error('❌ Fehler beim Aktualisieren der Sensoranzeige:', error);
      }
    }
    
    function startSensorRefresh() {
      setInterval(async () => {
        await loadSensorData();
      }, 30000);
    }

    // Load employees and projects for dropdowns
    async function loadDropdownData() {
      try {
        // Load employees
        const employeesResponse = await fetch('/api/employees');
        if (employeesResponse.ok) {
          const employees = await employeesResponse.json();
          const engineerSelect = document.getElementById('responsible_engineer');
          engineerSelect.innerHTML = '<option value="">Mitarbeiter auswählen...</option>';
          employees.forEach(employee => {
            const option = document.createElement('option');
            option.value = employee.displayName;
            option.textContent = employee.displayName;
            engineerSelect.appendChild(option);
          });
        }

        // Load projects
        const projectsResponse = await fetch('/api/projects');
        if (projectsResponse.ok) {
          const projects = await projectsResponse.json();
          const projectSelect = document.getElementById('project');
          projectSelect.innerHTML = '<option value="">Projekt auswählen...</option>';
          projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.name;
            option.textContent = project.name;
            projectSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error('❌ Fehler beim Laden der Dropdown-Daten:', error);
      }
    }

    // Initialize dropdowns on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadDropdownData();
    });
  </script>
  
  <style>
    /* Background Icon Anpassung für Add Component */
    .page-add-component .background-icon {
      width: 120% !important;
      max-width: 600px !important;
      opacity: 1 !important;
      filter: none !important;
      transform: translateX(-10%) translateY(-200px) !important;
    }

    /* Barcode Input Row Layout */
    .barcode-input-row {
      display: flex;
      gap: var(--space-md);
      align-items: stretch;
    }

    .barcode-input-half {
      flex: 1;
      max-width: 50%;
    }

    /* Compact Form Styling */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: var(--text-comic);
      font-family: var(--font-comic);
    }
    
    .photo-options {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .photo-options .comic-btn {
      flex: 1;
      min-width: 140px;
      max-width: 160px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .camera-section {
      margin: 20px 0;
      padding: 20px;
      border: var(--border-thick);
      border-radius: 15px;
      background: var(--bg-panel);
      text-align: center;
    }
    
    .inline-camera-container {
      margin-bottom: 15px;
    }
    
    .inline-camera-container video {
      border: var(--border-medium);
      border-radius: 10px;
      background: #000;
      box-shadow: var(--shadow-comic);
    }
    
    .inline-camera-controls {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    
    .inline-camera-controls .comic-btn {
      min-width: 140px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .comic-btn.active {
      background: var(--comic-primary);
      color: white;
      transform: scale(1.05);
    }
    
    .form-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }
    
    .action-btn-uniform {
      min-width: 120px;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .image-preview {
      margin-top: 10px;
    }
    
    .image-preview img {
      max-width: 200px;
      max-height: 150px;
      border: var(--border-thin);
      border-radius: 8px;
    }

    /* Barcode Input Group Styling */
    .barcode-input-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .barcode-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--primary-green);
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      background: var(--bg-card);
      color: var(--text-primary);
      transition: var(--smooth-transition);
    }

    .barcode-input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(196, 214, 0, 0.2);
    }

    .barcode-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .barcode-btn {
      flex: 1;
      min-width: 140px;
      max-width: 160px;
      padding: 12px 16px !important;
      font-size: 14px !important;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: var(--smooth-transition);
    }

    .barcode-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .barcode-btn svg {
      flex-shrink: 0;
    }

    /* KRITISCH: Modal-Fixes */
    .modal {
      display: none !important;
      opacity: 0 !important;
      visibility: hidden !important;
    }

    .modal.active {
      display: flex !important;
      opacity: 1 !important;
      visibility: visible !important;
    }

    /* Spinner Animation */
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      display: inline-block;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Scanner Modal Styles */
    .scanner-area {
      padding: 40px 20px;
      text-align: center;
      min-height: 300px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 30px;
    }

    .scanner-icon-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .scanner-icon {
      width: 80px;
      height: 80px;
      stroke: var(--primary-blue);
      opacity: 0.7;
    }

    .scanner-icon.blinking {
      animation: blink 1.5s infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 0.7; }
      51%, 100% { opacity: 0.3; }
    }

    .scanner-icon-container p {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .manual-input {
      width: 100%;
      max-width: 300px;
    }

    .manual-input input {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid var(--primary-blue);
      border-radius: 12px;
      font-size: 16px;
      text-align: center;
      background: var(--bg-card);
      color: var(--text-primary);
      transition: var(--smooth-transition);
    }

    .manual-input input:focus {
      outline: none;
      border-color: var(--primary-green);
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
    }

    /* Barcode Modal Styles */
    .barcode-print-content {
      max-width: 600px;
      width: 90%;
    }

    .barcode-display {
      padding: 30px;
    }

    .barcode-info {
      text-align: center;
      margin-bottom: 30px;
    }

    .barcode-info h4 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    .barcode-info p {
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .barcode-image-container {
      text-align: center;
      margin: 30px 0;
      padding: 20px;
      background: white;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .barcode-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 30px;
    }

    .barcode-actions .btn {
      flex: 1;
      max-width: 200px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
    }

    /* Navigation Lab Info Styles */
    .nav-left {
      display: flex;
      align-items: center;
      gap: 24px;
      flex: 1;
    }

    .lab-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .lab-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Navigation erweitert */
    .nav-left {
      display: flex !important;
      align-items: center !important;
      gap: 2rem !important;
      flex-grow: 1 !important;
    }
    
    .lab-info {
      display: flex !important;
      align-items: center !important;
      gap: 1rem !important;
    }
    
    .lab-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
      white-space: nowrap;
    }
    
    /* Mini Sensor Display in Header */
    .mini-sensors {
      display: flex;
      gap: 0.5rem;
    }
    
    .mini-sensor {
      font-size: 0.8rem;
      font-weight: 600;
      padding: 0.2rem 0.6rem;
      border-radius: 15px;
      background: var(--bg-light);
      border: 1px solid var(--border-color);
    }
    
    .mini-sensor.temp {
      color: #ff6b6b !important;
      border-color: #ff6b6b !important;
    }
    
    .mini-sensor.humid {
      color: #4ecdc4 !important;
      border-color: #4ecdc4 !important;
    }
    
    /* Location Dropdown Styling */
    .location-dropdown {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.3rem 0.8rem;
      outline: none;
      cursor: pointer;
      transition: border-color 0.2s ease;
    }
    
    .location-dropdown:hover {
      border-color: var(--primary-color);
    }
    
    .location-dropdown:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
    }

    /* Responsive Design für Barcode Section */
    @media (max-width: 480px) {
      .barcode-actions {
        flex-direction: column;
      }
      
      .barcode-btn {
        max-width: none;
      }

      .barcode-actions .btn {
        max-width: none;
      }

      .nav-left {
        gap: 1rem;
      }
      
      .lab-name {
        display: none;
      }
      
      .mini-sensors {
        gap: 0.25rem;
      }
      
      .mini-sensor {
        font-size: 0.75rem;
        padding: 0.15rem 0.4rem;
      }
    }
  </style>

  <!-- SENSOR CSS FIX - HÖCHSTE PRIORITÄT -->
  <style>
    .nav-left {
      display: flex !important;
      align-items: center !important;
      gap: 2rem !important;
      flex-grow: 1 !important;
      flex-direction: row !important;
    }
    
    .lab-info {
      display: flex !important;
      align-items: center !important;
      gap: 1rem !important;
      flex-direction: row !important;
      flex-wrap: nowrap !important;
    }
    
    .lab-name {
      font-size: 0.9rem !important;
      font-weight: 600 !important;
      color: var(--text-secondary) !important;
      white-space: nowrap !important;
      display: inline-block !important;
      margin-right: 0 !important;
    }
    
    .mini-sensors {
      display: inline-flex !important;
      gap: 0.5rem !important;
      flex-direction: row !important;
      align-items: center !important;
    }
    
    .mini-sensor {
      font-size: 0.8rem !important;
      font-weight: 600 !important;
      padding: 0.2rem 0.6rem !important;
      border-radius: 15px !important;
      background: var(--bg-light) !important;
      border: 1px solid var(--border-color) !important;
      display: inline-block !important;
    }
    
    .mini-sensor.temp {
      color: #ff6b6b !important;
      border-color: #ff6b6b !important;
    }
    
    .mini-sensor.humid {
      color: #4ecdc4 !important;
      border-color: #4ecdc4 !important;
    }
  </style>
</body>
</html>
